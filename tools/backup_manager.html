<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç† - å£²ä¸Šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            background: #f8f9fa;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        button {
            padding: 12px 24px;
            margin: 5px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        button:hover {
            background: #5a67d8;
        }
        button.success {
            background: #48bb78;
        }
        button.danger {
            background: #f56565;
        }
        button.warning {
            background: #ed8936;
        }
        .status-box {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .backup-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .backup-info {
            flex: 1;
        }
        .backup-actions {
            display: flex;
            gap: 10px;
        }
        pre {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
        }
        .success { color: #22c55e; font-weight: bold; }
        .error { color: #ef4444; font-weight: bold; }
        .warning { color: #f59e0b; font-weight: bold; }
        .info { color: #3b82f6; font-weight: bold; }
        .file-input {
            display: none;
        }
        .file-label {
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            display: inline-block;
            font-size: 14px;
            font-weight: bold;
        }
        .file-label:hover {
            background: #2563eb;
        }
        .auto-backup-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #e0e7ff;
            border-radius: 8px;
            margin: 10px 0;
        }
        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
        }
        .indicator.active {
            background: #22c55e;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†ã‚»ãƒ³ã‚¿ãƒ¼</h1>

        <!-- è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š -->
        <div class="section">
            <h2>ğŸ”„ è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š</h2>
            <div class="auto-backup-status">
                <span class="indicator" id="autoBackupIndicator"></span>
                <span id="autoBackupStatus">è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: åœæ­¢ä¸­</span>
            </div>
            <div class="status-box">
                <p><strong>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–“éš”:</strong></p>
                <select id="backupInterval" style="padding: 8px; font-size: 14px; border-radius: 5px;">
                    <option value="0">ç„¡åŠ¹</option>
                    <option value="3600000">1æ™‚é–“ã”ã¨</option>
                    <option value="21600000">6æ™‚é–“ã”ã¨</option>
                    <option value="43200000">12æ™‚é–“ã”ã¨</option>
                    <option value="86400000" selected>24æ™‚é–“ã”ã¨ï¼ˆæ¨å¥¨ï¼‰</option>
                    <option value="604800000">é€±1å›</option>
                </select>
                <button onclick="updateAutoBackup()" style="margin-left: 10px;">è¨­å®šã‚’ä¿å­˜</button>
            </div>
            <div class="status-box">
                <p class="info">æ¬¡å›ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: <span id="nextBackup">-</span></p>
                <p class="info">æœ€å¾Œã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: <span id="lastAutoBackup">-</span></p>
            </div>
        </div>

        <!-- æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— -->
        <div class="section">
            <h2>ğŸ’¼ æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="createBackup()" class="success">ä»Šã™ããƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</button>
                <button onclick="downloadBackup()">PCã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                <button onclick="emailBackup()" class="warning">ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ï¼ˆæº–å‚™ä¸­ï¼‰</button>
            </div>
            <div id="manualBackupStatus" class="status-box" style="margin-top: 15px;"></div>
        </div>

        <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´ -->
        <div class="section">
            <h2>ğŸ“š ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´</h2>
            <button onclick="loadBackupHistory()">å±¥æ­´ã‚’æ›´æ–°</button>
            <div id="backupHistory" style="margin-top: 15px;">
                <p style="color: #999;">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ -->
        <div class="section">
            <h2>ğŸ”§ ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ</h2>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <label for="fileInput" class="file-label">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ</label>
                <input type="file" id="fileInput" class="file-input" accept=".json" onchange="restoreFromFile(event)">
                <button onclick="restoreFromSupabase()" class="warning">Supabaseã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ</button>
                <button onclick="restoreFromLocalStorage()">ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒ</button>
            </div>
            <div id="restoreStatus" class="status-box" style="margin-top: 15px;"></div>
        </div>

        <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <div class="section">
            <h2>ğŸ‘ï¸ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
            <button onclick="previewCurrentData()">ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º</button>
            <div id="dataPreview" style="margin-top: 15px;"></div>
        </div>

        <!-- ä½¿ã„æ–¹ -->
        <div class="section">
            <h2>ğŸ“– ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½¿ã„æ–¹</h2>
            <div class="status-box">
                <h3>è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
                <ul>
                    <li>è¨­å®šã—ãŸé–“éš”ã§è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</li>
                    <li>ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨Supabaseã®ä¸¡æ–¹ã«ä¿å­˜</li>
                    <li>æœ€å¤§10ä»¶ã®å±¥æ­´ã‚’ä¿æŒ</li>
                </ul>

                <h3>æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
                <ul>
                    <li><strong>ä»Šã™ããƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</strong>: ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å³åº§ã«ä¿å­˜</li>
                    <li><strong>PCã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</strong>: JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦PCã«ä¿å­˜</li>
                    <li><strong>ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡</strong>: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ï¼ˆä»Šå¾Œå®Ÿè£…äºˆå®šï¼‰</li>
                </ul>

                <h3>ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ</h3>
                <ul>
                    <li><strong>ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ</strong>: PCã«ä¿å­˜ã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ</li>
                    <li><strong>Supabaseã‹ã‚‰å¾©å…ƒ</strong>: ã‚¯ãƒ©ã‚¦ãƒ‰ã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</li>
                    <li><strong>å±¥æ­´ã‹ã‚‰å¾©å…ƒ</strong>: éå»ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰é¸æŠã—ã¦å¾©å…ƒ</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Supabaseè¨­å®š
        const SUPABASE_URL = 'https://qddyqqmpqqkkbibplsmn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkZHlxcW1wcXFra2JpYnBsc21uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NTc5MTgsImV4cCI6MjA3MzIzMzkxOH0.KAgZ8D5cRgdPS-AoIeG7bwFiNzbGV8TW22rhGLft6sY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let autoBackupTimer = null;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.onload = function() {
            loadBackupSettings();
            loadBackupHistory();
            checkAutoBackupStatus();
        };

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®šã®èª­ã¿è¾¼ã¿
        function loadBackupSettings() {
            const settings = localStorage.getItem('backupSettings');
            if (settings) {
                const parsed = JSON.parse(settings);
                document.getElementById('backupInterval').value = parsed.interval || '0';
                if (parsed.interval && parsed.interval !== '0') {
                    startAutoBackup(parseInt(parsed.interval));
                }
            }
        }

        // è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®è¨­å®šæ›´æ–°
        function updateAutoBackup() {
            const interval = document.getElementById('backupInterval').value;
            const settings = {
                interval: interval,
                lastBackup: localStorage.getItem('lastAutoBackup') || null
            };
            localStorage.setItem('backupSettings', JSON.stringify(settings));

            if (interval === '0') {
                stopAutoBackup();
                alert('è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ç„¡åŠ¹ã«ã—ã¾ã—ãŸ');
            } else {
                startAutoBackup(parseInt(interval));
                alert(`è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆ${getIntervalText(interval)}ï¼‰`);
            }
        }

        // è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–‹å§‹
        function startAutoBackup(interval) {
            stopAutoBackup(); // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢

            // å³åº§ã«æœ€åˆã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
            createBackup(true);

            // å®šæœŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’è¨­å®š
            autoBackupTimer = setInterval(() => {
                createBackup(true);
            }, interval);

            // UIã‚’æ›´æ–°
            document.getElementById('autoBackupIndicator').classList.add('active');
            document.getElementById('autoBackupStatus').textContent = `è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: æœ‰åŠ¹ï¼ˆ${getIntervalText(interval.toString())}ï¼‰`;

            // æ¬¡å›ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ™‚åˆ»ã‚’è¡¨ç¤º
            const nextTime = new Date(Date.now() + interval);
            document.getElementById('nextBackup').textContent = nextTime.toLocaleString('ja-JP');
        }

        // è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—åœæ­¢
        function stopAutoBackup() {
            if (autoBackupTimer) {
                clearInterval(autoBackupTimer);
                autoBackupTimer = null;
            }
            document.getElementById('autoBackupIndicator').classList.remove('active');
            document.getElementById('autoBackupStatus').textContent = 'è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: åœæ­¢ä¸­';
            document.getElementById('nextBackup').textContent = '-';
        }

        // é–“éš”ã®ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›
        function getIntervalText(interval) {
            const intervals = {
                '3600000': '1æ™‚é–“ã”ã¨',
                '21600000': '6æ™‚é–“ã”ã¨',
                '43200000': '12æ™‚é–“ã”ã¨',
                '86400000': '24æ™‚é–“ã”ã¨',
                '604800000': 'é€±1å›'
            };
            return intervals[interval] || 'ä¸æ˜';
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
        async function createBackup(isAuto = false) {
            const statusDiv = isAuto ? null : document.getElementById('manualBackupStatus');
            if (statusDiv) statusDiv.innerHTML = '<p class="info">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆä¸­...</p>';

            try {
                // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
                const backupData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    type: isAuto ? 'auto' : 'manual',
                    data: {
                        calendar: localStorage.getItem('calendarData') ? JSON.parse(localStorage.getItem('calendarData')) : {},
                        weekly: localStorage.getItem('weeklyData') ? JSON.parse(localStorage.getItem('weeklyData')) : {},
                        deposit: localStorage.getItem('depositData') ? JSON.parse(localStorage.getItem('depositData')) : [],
                        withdraw: localStorage.getItem('withdrawData') ? JSON.parse(localStorage.getItem('withdrawData')) : []
                    }
                };

                // Supabaseã«ä¿å­˜
                const { error } = await supabase
                    .from('sales_data')
                    .upsert({
                        user_id: 'shared_user_2024',
                        data_type: `backup_${Date.now()}`,
                        data: JSON.stringify(backupData),
                        updated_at: backupData.timestamp
                    });

                if (error) throw error;

                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚‚ä¿å­˜ï¼ˆå±¥æ­´ã¨ã—ã¦ï¼‰
                const backupHistory = JSON.parse(localStorage.getItem('backupHistory') || '[]');
                backupHistory.unshift({
                    id: `backup_${Date.now()}`,
                    timestamp: backupData.timestamp,
                    type: backupData.type,
                    size: JSON.stringify(backupData).length
                });

                // æœ€å¤§10ä»¶ã¾ã§ä¿æŒ
                if (backupHistory.length > 10) {
                    backupHistory.pop();
                }

                localStorage.setItem('backupHistory', JSON.stringify(backupHistory));
                localStorage.setItem('lastBackup', JSON.stringify(backupData));

                if (isAuto) {
                    localStorage.setItem('lastAutoBackup', backupData.timestamp);
                    document.getElementById('lastAutoBackup').textContent = new Date(backupData.timestamp).toLocaleString('ja-JP');
                } else {
                    statusDiv.innerHTML = `
                        <p class="success">âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆæˆåŠŸï¼</p>
                        <p>ä½œæˆæ—¥æ™‚: ${new Date(backupData.timestamp).toLocaleString('ja-JP')}</p>
                        <p>ã‚µã‚¤ã‚º: ${(JSON.stringify(backupData).length / 1024).toFixed(2)} KB</p>
                    `;
                }

                loadBackupHistory();
                return backupData;

            } catch (error) {
                if (statusDiv) {
                    statusDiv.innerHTML = `<p class="error">âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
                }
                console.error('Backup error:', error);
                return null;
            }
        }

        // PCã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        async function downloadBackup() {
            const backup = await createBackup();
            if (!backup) return;

            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            link.href = url;
            link.download = `å£²ä¸Šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼_ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—_${timestamp}.json`;
            link.click();
            URL.revokeObjectURL(url);

            document.getElementById('manualBackupStatus').innerHTML += '<p class="success">âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†</p>';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ
        function restoreFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);

                    if (!backup.data) {
                        throw new Error('ç„¡åŠ¹ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«');
                    }

                    if (confirm(`${new Date(backup.timestamp).toLocaleString('ja-JP')} ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\n\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) {
                        // ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
                        if (backup.data.calendar) localStorage.setItem('calendarData', JSON.stringify(backup.data.calendar));
                        if (backup.data.weekly) localStorage.setItem('weeklyData', JSON.stringify(backup.data.weekly));
                        if (backup.data.deposit) localStorage.setItem('depositData', JSON.stringify(backup.data.deposit));
                        if (backup.data.withdraw) localStorage.setItem('withdrawData', JSON.stringify(backup.data.withdraw));

                        document.getElementById('restoreStatus').innerHTML = `
                            <p class="success">âœ… å¾©å…ƒæˆåŠŸï¼</p>
                            <p>å¾©å…ƒå…ƒ: ${new Date(backup.timestamp).toLocaleString('ja-JP')}</p>
                            <p>ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å¤‰æ›´ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                        `;

                        // Supabaseã«ã‚‚ä¿å­˜
                        saveRestoredDataToSupabase();
                    }
                } catch (error) {
                    document.getElementById('restoreStatus').innerHTML = `<p class="error">âŒ å¾©å…ƒã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
                }
            };
            reader.readAsText(file);
        }

        // Supabaseã‹ã‚‰å¾©å…ƒ
        async function restoreFromSupabase() {
            const statusDiv = document.getElementById('restoreStatus');
            statusDiv.innerHTML = '<p class="info">Supabaseã‹ã‚‰å¾©å…ƒä¸­...</p>';

            try {
                // å„ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ã‚’å–å¾—
                const types = ['calendar', 'weekly', 'deposit', 'withdraw'];
                let restored = 0;

                for (const type of types) {
                    const { data, error } = await supabase
                        .from('sales_data')
                        .select('*')
                        .eq('user_id', 'shared_user_2024')
                        .eq('data_type', type)
                        .single();

                    if (data) {
                        localStorage.setItem(`${type}Data`, data.data);
                        localStorage.setItem(`${type}DataUpdated`, data.updated_at);
                        restored++;
                    }
                }

                statusDiv.innerHTML = `
                    <p class="success">âœ… Supabaseã‹ã‚‰å¾©å…ƒæˆåŠŸï¼</p>
                    <p>${restored}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ</p>
                    <p>ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å¤‰æ›´ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                `;

            } catch (error) {
                statusDiv.innerHTML = `<p class="error">âŒ å¾©å…ƒã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒ
        function restoreFromLocalStorage() {
            const lastBackup = localStorage.getItem('lastBackup');
            if (!lastBackup) {
                document.getElementById('restoreStatus').innerHTML = '<p class="warning">âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            try {
                const backup = JSON.parse(lastBackup);

                if (confirm(`${new Date(backup.timestamp).toLocaleString('ja-JP')} ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ`)) {
                    if (backup.data.calendar) localStorage.setItem('calendarData', JSON.stringify(backup.data.calendar));
                    if (backup.data.weekly) localStorage.setItem('weeklyData', JSON.stringify(backup.data.weekly));
                    if (backup.data.deposit) localStorage.setItem('depositData', JSON.stringify(backup.data.deposit));
                    if (backup.data.withdraw) localStorage.setItem('withdrawData', JSON.stringify(backup.data.withdraw));

                    document.getElementById('restoreStatus').innerHTML = `
                        <p class="success">âœ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒæˆåŠŸï¼</p>
                        <p>ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å¤‰æ›´ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    `;
                }
            } catch (error) {
                document.getElementById('restoreStatus').innerHTML = `<p class="error">âŒ å¾©å…ƒã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        // å¾©å…ƒãƒ‡ãƒ¼ã‚¿ã‚’Supabaseã«ä¿å­˜
        async function saveRestoredDataToSupabase() {
            const types = ['calendar', 'weekly', 'deposit', 'withdraw'];
            for (const type of types) {
                const data = localStorage.getItem(`${type}Data`);
                if (data) {
                    await supabase
                        .from('sales_data')
                        .upsert({
                            user_id: 'shared_user_2024',
                            data_type: type,
                            data: data,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'user_id,data_type'
                        });
                }
            }
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´ã®èª­ã¿è¾¼ã¿
        async function loadBackupHistory() {
            const historyDiv = document.getElementById('backupHistory');
            historyDiv.innerHTML = '<p style="color: #999;">å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';

            try {
                // Supabaseã‹ã‚‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´ã‚’å–å¾—
                const { data, error } = await supabase
                    .from('sales_data')
                    .select('*')
                    .eq('user_id', 'shared_user_2024')
                    .like('data_type', 'backup_%')
                    .order('updated_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                if (data && data.length > 0) {
                    historyDiv.innerHTML = '';
                    data.forEach(backup => {
                        const backupData = JSON.parse(backup.data);
                        const div = document.createElement('div');
                        div.className = 'backup-item';
                        div.innerHTML = `
                            <div class="backup-info">
                                <p><strong>${backupData.type === 'auto' ? 'ğŸ”„ è‡ªå‹•' : 'ğŸ‘¤ æ‰‹å‹•'}ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</strong></p>
                                <p>ä½œæˆæ—¥æ™‚: ${new Date(backupData.timestamp).toLocaleString('ja-JP')}</p>
                                <p>ã‚µã‚¤ã‚º: ${(JSON.stringify(backupData).length / 1024).toFixed(2)} KB</p>
                            </div>
                            <div class="backup-actions">
                                <button onclick="restoreFromBackup('${backup.data_type}')" class="warning">å¾©å…ƒ</button>
                                <button onclick="deleteBackup('${backup.data_type}')" class="danger">å‰Šé™¤</button>
                            </div>
                        `;
                        historyDiv.appendChild(div);
                    });
                } else {
                    historyDiv.innerHTML = '<p style="color: #999;">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                }

            } catch (error) {
                historyDiv.innerHTML = `<p class="error">âŒ å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        // ç‰¹å®šã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
        async function restoreFromBackup(backupId) {
            if (!confirm('ã“ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) return;

            try {
                const { data, error } = await supabase
                    .from('sales_data')
                    .select('*')
                    .eq('user_id', 'shared_user_2024')
                    .eq('data_type', backupId)
                    .single();

                if (error) throw error;

                const backup = JSON.parse(data.data);

                // ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
                if (backup.data.calendar) localStorage.setItem('calendarData', JSON.stringify(backup.data.calendar));
                if (backup.data.weekly) localStorage.setItem('weeklyData', JSON.stringify(backup.data.weekly));
                if (backup.data.deposit) localStorage.setItem('depositData', JSON.stringify(backup.data.deposit));
                if (backup.data.withdraw) localStorage.setItem('withdrawData', JSON.stringify(backup.data.withdraw));

                alert('å¾©å…ƒæˆåŠŸï¼ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                location.reload();

            } catch (error) {
                alert('å¾©å…ƒã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰Šé™¤
        async function deleteBackup(backupId) {
            if (!confirm('ã“ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const { error } = await supabase
                    .from('sales_data')
                    .delete()
                    .eq('user_id', 'shared_user_2024')
                    .eq('data_type', backupId);

                if (error) throw error;

                loadBackupHistory();

            } catch (error) {
                alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        function previewCurrentData() {
            const previewDiv = document.getElementById('dataPreview');

            const calendarData = localStorage.getItem('calendarData') ? JSON.parse(localStorage.getItem('calendarData')) : {};
            const weeklyData = localStorage.getItem('weeklyData') ? JSON.parse(localStorage.getItem('weeklyData')) : {};
            const depositData = localStorage.getItem('depositData') ? JSON.parse(localStorage.getItem('depositData')) : [];
            const withdrawData = localStorage.getItem('withdrawData') ? JSON.parse(localStorage.getItem('withdrawData')) : [];

            const preview = {
                ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿: Object.keys(calendarData).length + 'ä»¶',
                é€±è¨ˆãƒ‡ãƒ¼ã‚¿: Object.keys(weeklyData).length + 'ä»¶',
                å…¥é‡‘ãƒ‡ãƒ¼ã‚¿: depositData.length + 'ä»¶',
                å‡ºé‡‘ãƒ‡ãƒ¼ã‚¿: withdrawData.length + 'ä»¶',
                æœ€çµ‚æ›´æ–°: {
                    ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼: localStorage.getItem('calendarDataUpdated') || 'æœªæ›´æ–°',
                    é€±è¨ˆ: localStorage.getItem('weeklyDataUpdated') || 'æœªæ›´æ–°',
                    å…¥é‡‘: localStorage.getItem('depositDataUpdated') || 'æœªæ›´æ–°',
                    å‡ºé‡‘: localStorage.getItem('withdrawDataUpdated') || 'æœªæ›´æ–°'
                }
            };

            previewDiv.innerHTML = `<pre>${JSON.stringify(preview, null, 2)}</pre>`;
        }

        // è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çŠ¶æ…‹ã®ç¢ºèª
        function checkAutoBackupStatus() {
            const lastAutoBackup = localStorage.getItem('lastAutoBackup');
            if (lastAutoBackup) {
                document.getElementById('lastAutoBackup').textContent = new Date(lastAutoBackup).toLocaleString('ja-JP');
            }
        }

        // ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
        function emailBackup() {
            alert('ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™ã€‚\nç¾åœ¨ã¯PCã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚');
        }
    </script>
</body>
</html>