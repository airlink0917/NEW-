<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£²ä¸Šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ åŒæœŸç¢ºèªãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            background: #f8f9fa;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #5a67d8;
        }
        button.success {
            background: #48bb78;
        }
        button.danger {
            background: #f56565;
        }
        .success {
            color: #22c55e;
            font-weight: bold;
        }
        .error {
            color: #ef4444;
            font-weight: bold;
        }
        .warning {
            color: #f59e0b;
            font-weight: bold;
        }
        .status-box {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        pre {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: #f3f4f6;
            font-weight: 600;
        }
        .sync-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .sync-active {
            background: #22c55e;
            animation: pulse 2s infinite;
        }
        .sync-inactive {
            background: #ef4444;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’° å£²ä¸Šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ åŒæœŸç¢ºèªãƒ„ãƒ¼ãƒ«</h1>

        <!-- æ¥ç¶šçŠ¶æ…‹ -->
        <div class="section">
            <h2>1ï¸âƒ£ æ¥ç¶šçŠ¶æ…‹</h2>
            <button onclick="checkConnection()">æ¥ç¶šç¢ºèª</button>
            <div id="connectionStatus" class="status-box"></div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ†ã‚¹ãƒˆ -->
        <div class="section">
            <h2>2ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="testDataSync()">åŒæœŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <button onclick="loadCurrentData()" class="success">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª</button>
            <div id="syncTest" class="status-box"></div>
        </div>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDç¢ºèª -->
        <div class="section">
            <h2>3ï¸âƒ£ ãƒ¦ãƒ¼ã‚¶ãƒ¼IDè¨­å®š</h2>
            <button onclick="checkUserId()">ãƒ¦ãƒ¼ã‚¶ãƒ¼IDç¢ºèª</button>
            <div id="userIdStatus" class="status-box"></div>
        </div>

        <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸçŠ¶æ…‹ -->
        <div class="section">
            <h2>4ï¸âƒ£ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ</h2>
            <button onclick="testRealtimeSync()">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸãƒ†ã‚¹ãƒˆ</button>
            <button onclick="clearTestData()" class="danger">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
            <div id="realtimeStatus" class="status-box"></div>
        </div>

        <!-- ãƒ‡ãƒã‚¤ã‚¹é–“åŒæœŸç¢ºèª -->
        <div class="section">
            <h2>5ï¸âƒ£ ãƒ‡ãƒã‚¤ã‚¹é–“åŒæœŸç¢ºèªæ‰‹é †</h2>
            <div class="status-box">
                <ol>
                    <li><strong>ã“ã®ãƒšãƒ¼ã‚¸ã‚’2ã¤ã®ãƒ‡ãƒã‚¤ã‚¹ã§é–‹ã</strong></li>
                    <li><strong>ãƒ‡ãƒã‚¤ã‚¹1ã§ã€ŒåŒæœŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯</strong></li>
                    <li><strong>ãƒ‡ãƒã‚¤ã‚¹2ã§ã€Œç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã€ã‚’ã‚¯ãƒªãƒƒã‚¯</strong></li>
                    <li><strong>åŒã˜ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°åŒæœŸæˆåŠŸï¼</strong></li>
                </ol>
                <p>ç¾åœ¨ã®URL: <code>https://new-id68.vercel.app</code></p>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://qddyqqmpqqkkbibplsmn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkZHlxcW1wcXFra2JpYnBsc21uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NTc5MTgsImV4cCI6MjA3MzIzMzkxOH0.KAgZ8D5cRgdPS-AoIeG7bwFiNzbGV8TW22rhGLft6sY';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // æ¥ç¶šç¢ºèª
        async function checkConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = '<p>æ¥ç¶šç¢ºèªä¸­...</p>';

            try {
                const { data, error } = await supabase
                    .from('sales_data')
                    .select('count', { count: 'exact' });

                if (error) {
                    statusDiv.innerHTML = `
                        <p class="error">âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                        <p>ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ${error.code}</p>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <p class="success">âœ… Supabaseæ¥ç¶šæˆåŠŸ</p>
                        <p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: qddyqqmpqqkkbibplsmn</p>
                        <p>URL: ${SUPABASE_URL}</p>
                        <div><span class="sync-indicator sync-active"></span>æ¥ç¶šçŠ¶æ…‹: ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDç¢ºèª
        function checkUserId() {
            const statusDiv = document.getElementById('userIdStatus');
            const userId = 'shared_user_2024'; // supabase-sync.jsã¨åŒã˜ID

            statusDiv.innerHTML = `
                <table>
                    <tr>
                        <th>è¨­å®šé …ç›®</th>
                        <th>å€¤</th>
                        <th>çŠ¶æ…‹</th>
                    </tr>
                    <tr>
                        <td>å…±é€šãƒ¦ãƒ¼ã‚¶ãƒ¼ID</td>
                        <td><code>${userId}</code></td>
                        <td class="success">âœ… å…¨ãƒ‡ãƒã‚¤ã‚¹å…±é€š</td>
                    </tr>
                    <tr>
                        <td>ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸</td>
                        <td>${localStorage.getItem('userId') || 'æœªè¨­å®š'}</td>
                        <td>${localStorage.getItem('userId') ? 'âš ï¸ å€‹åˆ¥IDï¼ˆç„¡åŠ¹ï¼‰' : 'âœ… æœªä½¿ç”¨'}</td>
                    </tr>
                </table>
                <p class="success">å…¨ãƒ‡ãƒã‚¤ã‚¹ã§ã€Œshared_user_2024ã€ã‚’ä½¿ç”¨ä¸­</p>
            `;
        }

        // ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ†ã‚¹ãƒˆ
        async function testDataSync() {
            const statusDiv = document.getElementById('syncTest');
            statusDiv.innerHTML = '<p>åŒæœŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</p>';

            const testData = {
                [`test_${Date.now()}`]: {
                    amount: Math.floor(Math.random() * 10000),
                    note: `ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ ${new Date().toLocaleString('ja-JP')}`,
                    timestamp: Date.now()
                }
            };

            try {
                // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                const { error: saveError } = await supabase
                    .from('sales_data')
                    .upsert({
                        user_id: 'shared_user_2024',
                        data_type: 'test_sync',
                        data: JSON.stringify(testData),
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id,data_type'
                    });

                if (saveError) throw saveError;

                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                const { data: loadData, error: loadError } = await supabase
                    .from('sales_data')
                    .select('*')
                    .eq('user_id', 'shared_user_2024')
                    .eq('data_type', 'test_sync')
                    .single();

                if (loadError) throw loadError;

                statusDiv.innerHTML = `
                    <p class="success">âœ… åŒæœŸãƒ†ã‚¹ãƒˆæˆåŠŸï¼</p>
                    <p>ä¿å­˜ãƒ‡ãƒ¼ã‚¿:</p>
                    <pre>${JSON.stringify(testData, null, 2)}</pre>
                    <p>èª­ã¿è¾¼ã¿ãƒ‡ãƒ¼ã‚¿:</p>
                    <pre>${JSON.stringify(JSON.parse(loadData.data), null, 2)}</pre>
                    <p>æ›´æ–°æ™‚åˆ»: ${new Date(loadData.updated_at).toLocaleString('ja-JP')}</p>
                `;

            } catch (error) {
                statusDiv.innerHTML = `
                    <p class="error">âŒ åŒæœŸã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                    <pre>${JSON.stringify(error, null, 2)}</pre>
                `;
            }
        }

        // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ç¢ºèª
        async function loadCurrentData() {
            const statusDiv = document.getElementById('syncTest');
            statusDiv.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</p>';

            try {
                const { data, error } = await supabase
                    .from('sales_data')
                    .select('*')
                    .eq('user_id', 'shared_user_2024')
                    .order('updated_at', { ascending: false });

                if (error) throw error;

                let html = `<p class="success">âœ… ãƒ‡ãƒ¼ã‚¿${data.length}ä»¶å–å¾—</p>`;
                html += '<table>';
                html += '<tr><th>ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—</th><th>æ›´æ–°æ—¥æ™‚</th><th>ã‚µã‚¤ã‚º</th></tr>';

                data.forEach(row => {
                    const size = new Blob([row.data]).size;
                    html += `<tr>
                        <td>${row.data_type}</td>
                        <td>${new Date(row.updated_at).toLocaleString('ja-JP')}</td>
                        <td>${size}ãƒã‚¤ãƒˆ</td>
                    </tr>`;
                });
                html += '</table>';

                statusDiv.innerHTML = html;

            } catch (error) {
                statusDiv.innerHTML = `<p class="error">âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸãƒ†ã‚¹ãƒˆ
        function testRealtimeSync() {
            const statusDiv = document.getElementById('realtimeStatus');

            statusDiv.innerHTML = `
                <p class="warning">âš ï¸ å£²ä¸Šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯æ‰‹å‹•åŒæœŸæ–¹å¼ã§ã™</p>
                <p>åŒæœŸã‚¿ã‚¤ãƒŸãƒ³ã‚°:</p>
                <ul>
                    <li>ãƒ‡ãƒ¼ã‚¿å…¥åŠ›æ™‚ã«è‡ªå‹•ä¿å­˜</li>
                    <li>ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•èª­ã¿è¾¼ã¿</li>
                    <li>ä»–ãƒ‡ãƒã‚¤ã‚¹ã®å¤‰æ›´ã¯ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã§åæ˜ </li>
                </ul>
                <p>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸãŒå¿…è¦ãªå ´åˆã¯ã€å®šæœŸçš„ãªè‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã®è¿½åŠ ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚</p>
            `;
        }

        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        async function clearTestData() {
            const statusDiv = document.getElementById('syncTest');

            if (!confirm('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                const { error } = await supabase
                    .from('sales_data')
                    .delete()
                    .eq('user_id', 'shared_user_2024')
                    .eq('data_type', 'test_sync');

                if (error) throw error;

                statusDiv.innerHTML = '<p class="success">âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ</p>';

            } catch (error) {
                statusDiv.innerHTML = `<p class="error">âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        window.onload = function() {
            checkConnection();
            checkUserId();
        };
    </script>
</body>
</html>