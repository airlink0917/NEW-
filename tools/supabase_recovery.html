<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabaseãƒ‡ãƒ¼ã‚¿å¾©å…ƒã¨è¨ºæ–­</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
        button:hover { background: #0056b3; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Supabaseãƒ‡ãƒ¼ã‚¿å¾©å…ƒã¨è¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>

    <div class="section">
        <h2>1. Supabaseæ¥ç¶šè¨ºæ–­</h2>
        <button onclick="checkConnection()">æ¥ç¶šç¢ºèª</button>
        <div id="connectionStatus"></div>
    </div>

    <div class="section">
        <h2>2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª</h2>
        <button onclick="checkTables()">ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª</button>
        <div id="tableStatus"></div>
    </div>

    <div class="section">
        <h2>3. å‰Šé™¤ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒï¼ˆPoint-in-Time Recoveryï¼‰</h2>
        <p class="warning">âš ï¸ ã“ã®æ©Ÿèƒ½ã¯Supabaseã®Proä»¥ä¸Šã®ãƒ—ãƒ©ãƒ³ãŒå¿…è¦ã§ã™</p>
        <button onclick="checkBackupStatus()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çŠ¶æ…‹ç¢ºèª</button>
        <div id="backupStatus"></div>
    </div>

    <div class="section">
        <h2>4. ãƒ†ãƒ¼ãƒ–ãƒ«å†ä½œæˆã¨ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ</h2>
        <button onclick="recreateTable()">ãƒ†ãƒ¼ãƒ–ãƒ«å†ä½œæˆ</button>
        <button onclick="restoreFromLocal()">ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å¾©å…ƒ</button>
        <div id="recreateStatus"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://qddyqqmpqqkkbibplsmn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkZHlxcW1wcXFra2JpYnBsc21uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NTc5MTgsImV4cCI6MjA3MzIzMzkxOH0.KAgZ8D5cRgdPS-AoIeG7bwFiNzbGV8TW22rhGLft6sY';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function checkConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = '<p>æ¥ç¶šç¢ºèªä¸­...</p>';

            try {
                // æ¥ç¶šãƒ†ã‚¹ãƒˆ
                const { data, error } = await supabase.from('sales_data').select('count', { count: 'exact' });

                if (error) {
                    if (error.code === '42P01') {
                        statusDiv.innerHTML = '<p class="warning">âš ï¸ ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“</p>';
                    } else {
                        statusDiv.innerHTML = `<p class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
                    }
                } else {
                    statusDiv.innerHTML = '<p class="success">âœ… Supabaseæ¥ç¶šæˆåŠŸ</p>';
                }

                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±è¡¨ç¤º
                statusDiv.innerHTML += `
                    <div style="margin-top: 10px;">
                        <p><strong>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID:</strong> qddyqqmpqqkkbibplsmn</p>
                        <p><strong>URL:</strong> ${SUPABASE_URL}</p>
                    </div>
                `;

            } catch (error) {
                statusDiv.innerHTML = `<p class="error">âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        async function checkTables() {
            const statusDiv = document.getElementById('tableStatus');
            statusDiv.innerHTML = '<p>ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèªä¸­...</p>';

            try {
                // sales_dataãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const { data, error, count } = await supabase
                    .from('sales_data')
                    .select('*', { count: 'exact' })
                    .order('updated_at', { ascending: false });

                if (error) {
                    if (error.code === '42P01') {
                        statusDiv.innerHTML = `
                            <p class="error">âŒ ãƒ†ãƒ¼ãƒ–ãƒ« "sales_data" ãŒå­˜åœ¨ã—ã¾ã›ã‚“</p>
                            <p>ã€Œãƒ†ãƒ¼ãƒ–ãƒ«å†ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
                        `;
                    } else {
                        statusDiv.innerHTML = `<p class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
                    }
                    return;
                }

                let html = `<p class="success">âœ… ãƒ†ãƒ¼ãƒ–ãƒ« "sales_data" å­˜åœ¨ç¢ºèª</p>`;
                html += `<p>ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: ${count || 0}ä»¶</p>`;

                if (data && data.length > 0) {
                    html += '<table>';
                    html += '<tr><th>User ID</th><th>Data Type</th><th>æ›´æ–°æ—¥æ™‚</th><th>ãƒ‡ãƒ¼ã‚¿(ä¸€éƒ¨)</th></tr>';

                    data.forEach(row => {
                        const preview = JSON.stringify(row.data).substring(0, 50) + '...';
                        const date = new Date(row.updated_at).toLocaleString('ja-JP');
                        html += `<tr>
                            <td>${row.user_id}</td>
                            <td>${row.data_type}</td>
                            <td>${date}</td>
                            <td>${preview}</td>
                        </tr>`;
                    });
                    html += '</table>';
                } else {
                    html += '<p class="warning">âš ï¸ ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å­˜åœ¨ã—ã¾ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                }

                statusDiv.innerHTML = html;

            } catch (error) {
                statusDiv.innerHTML = `<p class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        async function checkBackupStatus() {
            const statusDiv = document.getElementById('backupStatus');
            statusDiv.innerHTML = `
                <h3>Supabaseã§ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒæ–¹æ³•ï¼š</h3>
                <ol>
                    <li><a href="https://supabase.com/dashboard/project/qddyqqmpqqkkbibplsmn" target="_blank">Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>ã«ãƒ­ã‚°ã‚¤ãƒ³</li>
                    <li>å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€ŒDatabaseã€â†’ã€ŒBackupsã€ã‚’é¸æŠ</li>
                    <li>ã€ŒPoint-in-Time Recoveryã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª</li>
                    <li>ã‚‚ã—æœ‰åŠ¹ãªå ´åˆã€å¾©å…ƒã—ãŸã„æ—¥æ™‚ã‚’é¸æŠ</li>
                    <li>ã€ŒRestoreã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                </ol>
                <p class="warning">âš ï¸ ç„¡æ–™ãƒ—ãƒ©ãƒ³ã§ã¯ã“ã®æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“</p>
            `;
        }

        async function recreateTable() {
            const statusDiv = document.getElementById('recreateStatus');
            statusDiv.innerHTML = '<p>ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆä¸­...</p>';

            const createTableSQL = `
                -- æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤ï¼ˆæ³¨æ„ï¼šãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰
                -- DROP TABLE IF EXISTS sales_data;

                -- ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
                CREATE TABLE IF NOT EXISTS sales_data (
                    id SERIAL PRIMARY KEY,
                    user_id VARCHAR(255) NOT NULL,
                    data_type VARCHAR(50) NOT NULL,
                    data JSONB NOT NULL,
                    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                    UNIQUE(user_id, data_type)
                );

                -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆ
                CREATE INDEX IF NOT EXISTS idx_sales_data_user_id ON sales_data(user_id);
                CREATE INDEX IF NOT EXISTS idx_sales_data_data_type ON sales_data(data_type);
                CREATE INDEX IF NOT EXISTS idx_sales_data_updated_at ON sales_data(updated_at);
            `;

            statusDiv.innerHTML = `
                <h3>ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆç”¨SQLï¼š</h3>
                <pre>${createTableSQL}</pre>
                <p>æ‰‹é †ï¼š</p>
                <ol>
                    <li><a href="https://supabase.com/dashboard/project/qddyqqmpqqkkbibplsmn/sql/new" target="_blank">SQL Editor</a>ã‚’é–‹ã</li>
                    <li>ä¸Šè¨˜ã®SQLã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆ</li>
                    <li>ã€ŒRunã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                </ol>
            `;
        }

        async function restoreFromLocal() {
            const statusDiv = document.getElementById('recreateStatus');
            statusDiv.innerHTML = '<p>ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¾©å…ƒä¸­...</p>';

            const userId = 'shared_user_2024';
            const results = [];

            // å„ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ã‚’å¾©å…ƒ
            const dataTypes = [
                { key: 'calendarData', type: 'calendar' },
                { key: 'weeklyData', type: 'weekly' },
                { key: 'depositData', type: 'deposit' },
                { key: 'withdrawData', type: 'withdraw' }
            ];

            for (const { key, type } of dataTypes) {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const { error } = await supabase
                            .from('sales_data')
                            .upsert({
                                user_id: userId,
                                data_type: type,
                                data: data,
                                updated_at: new Date().toISOString()
                            }, {
                                onConflict: 'user_id,data_type'
                            });

                        if (error) throw error;
                        results.push(`<p class="success">âœ… ${type} ãƒ‡ãƒ¼ã‚¿å¾©å…ƒæˆåŠŸ</p>`);
                    } catch (error) {
                        results.push(`<p class="error">âŒ ${type} ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå¤±æ•—: ${error.message}</p>`);
                    }
                } else {
                    results.push(`<p class="warning">âš ï¸ ${type} ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ãªã—</p>`);
                }
            }

            statusDiv.innerHTML = '<h3>å¾©å…ƒçµæœ:</h3>' + results.join('');
        }
    </script>
</body>
</html>