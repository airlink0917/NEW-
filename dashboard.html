<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#667eea">
    <title>Â£≤‰∏äÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-sync.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            overflow-x: hidden;
            width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            width: 100%;
            position: relative;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* iOS Safe Area Support */
        @supports (padding: env(safe-area-inset-top)) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-right: env(safe-area-inset-right);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
            }
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 400px;
        }

        .login-container h2 {
            margin-bottom: 30px;
            color: #333;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5a67d8;
        }

        .dashboard {
            display: none;
            background: #f3f4f6;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .dashboard-container {
            display: flex;
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 1000;
        }
        
        .sidebar.mobile-closed {
            transform: translateX(-100%);
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .sidebar-title {
            opacity: 0;
        }

        .toggle-sidebar {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6b7280;
            padding: 5px;
        }

        .sidebar-menu {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .menu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            color: #4b5563;
            text-decoration: none;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
        }

        .menu-item:hover {
            background: #f3f4f6;
        }

        .menu-item.active {
            background: #eef2ff;
            color: #667eea;
            border-left: 3px solid #667eea;
        }

        .menu-item span {
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .menu-item span {
            display: none;
        }

        .sidebar.collapsed .menu-item {
            padding: 12px;
            justify-content: center;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px;
            background: white;
            margin: 20px;
            margin-left: 270px; /* Add space for sidebar on PC */
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            -webkit-overflow-scrolling: touch;
            min-width: 0;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .dashboard h1 {
            color: #333;
        }

        .logout-btn {
            padding: 8px 20px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #4b5563;
        }

        .calendar-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 500;
            color: #555;
        }

        .control-group select, .control-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .nav-btn:hover {
            background: #5a67d8;
        }

        .yearly-summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .yearly-summary-table th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: left;
            font-size: 12px;
        }

        .yearly-summary-table td {
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 12px;
        }

        .yearly-summary-table tr:hover {
            background: #f9fafb;
        }

        .yearly-total-row {
            background: #f3f4f6;
            font-weight: bold;
        }

        .yearly-total-row td {
            border-top: 2px solid #667eea;
        }

        .profit-positive {
            color: #059669;
            font-weight: bold;
        }

        .profit-negative {
            color: #dc2626;
            font-weight: bold;
        }

        /* Cashflow Styles */
        .cashflow-container {
            padding: 20px;
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
        }

        .month-selector-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .month-selector {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .month-selector .form-group {
            margin-bottom: 0;
        }

        .month-selector .form-control {
            width: 120px;
        }

        .cashflow-section {
            background: #f9fafb;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            width: 100%;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .deposit-form, .withdraw-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .withdraw-amount {
            color: #dc2626 !important;
            font-weight: bold;
        }

        .deposit-amount {
            color: #059669 !important;
            font-weight: bold;
        }

        .calendar-deposit {
            color: #059669;
            font-weight: bold;
            background: #d1fae5;
            padding: 1px 3px;
            border-radius: 3px;
            font-size: 10px;
            margin-top: 2px;
        }

        .summary-section {
            background: white !important;
            border: 2px solid #667eea;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .summary-label {
            font-weight: 500;
            color: #4b5563;
        }

        .summary-value {
            font-size: 18px;
            font-weight: bold;
        }

        .cashflow-split-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-bottom: 20px;
            width: 100%;
        }

        .cashflow-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        .form-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        @media screen and (max-width: 1024px) {
            .cashflow-split-container {
                flex-direction: column;
            }
            
            .cashflow-table {
                font-size: 12px;
            }
            
            .cashflow-table th,
            .cashflow-table td {
                padding: 8px 6px;
            }
        }
        
        @media screen and (max-width: 768px) {
            .cashflow-container {
                padding: 10px;
            }
            
            .month-selector-section {
                padding: 15px;
            }
            
            .month-selector {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                justify-content: space-between;
            }
            
            .month-selector .form-group {
                width: calc(50% - 5px);
                display: inline-block;
            }
            
            .month-selector .form-control {
                width: 100%;
            }
            
            .month-selector button {
                width: calc(50% - 5px);
            }
            
            .cashflow-section {
                padding: 15px;
                margin-bottom: 15px;
                width: 100%;
            }
            
            /* „É¢„Éê„Ç§„É´„Åß„ÅÆ„Éú„Çø„É≥ÈÖçÁΩÆ */
            div[style*="justify-content: center"] {
                flex-wrap: wrap !important;
            }
            
            div[style*="justify-content: center"] button {
                min-width: 140px !important;
                flex: 1;
            }
            
            .form-column {
                gap: 10px;
            }
            
            .btn-primary {
                width: 100%;
                padding: 12px;
                font-size: 16px;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .cashflow-table {
                min-width: 500px;
                font-size: 11px;
            }
            
            .cashflow-table th,
            .cashflow-table td {
                padding: 8px 4px;
            }
            
            .btn-edit,
            .btn-delete {
                padding: 6px 8px;
                font-size: 11px;
                margin: 2px;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 15px;
            }
            
            .summary-item {
                padding: 12px;
            }
            
            .summary-value {
                font-size: 16px;
            }
        }
        
        @media screen and (max-width: 480px) {
            .section-title {
                font-size: 16px;
                margin-bottom: 15px;
            }
            
            .form-control {
                padding: 12px;
                font-size: 16px;
            }
            
            .cashflow-table {
                font-size: 10px;
            }
            
            .total-section {
                padding: 12px;
            }
            
            .total-value {
                font-size: 18px;
            }
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-primary {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
            white-space: nowrap;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .table-container {
            background: white;
            border-radius: 8px;
            overflow-x: auto;
            overflow-y: visible;
            border: 1px solid #e5e7eb;
            -webkit-overflow-scrolling: touch;
        }

        .cashflow-table {
            width: 100%;
            border-collapse: collapse;
        }

        .cashflow-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 14px;
            font-weight: 500;
        }

        .cashflow-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .cashflow-table tr:hover {
            background: #f9fafb;
        }

        .no-data-message {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
            font-size: 14px;
        }

        .total-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .total-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
        }

        .total-label {
            font-weight: 500;
            color: #4b5563;
        }

        .total-value {
            font-size: 20px;
            font-weight: bold;
            color: #059669;
        }

        .btn-delete {
            padding: 5px 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .btn-edit {
            padding: 5px 10px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
            margin-right: 5px;
        }

        .btn-edit:hover {
            background: #d97706;
        }

        /* Mobile menu toggle button */
        .mobile-menu-toggle {
            display: none;
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1001;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .mobile-overlay.active {
            display: block;
        }
        
        /* Prevent horizontal scroll on all devices */
        @media screen and (max-width: 1024px) {
            body, html {
                overflow-x: hidden !important;
                width: 100% !important;
                position: relative !important;
            }
            
            .dashboard {
                width: 100vw !important;
                max-width: 100vw !important;
                overflow-x: hidden !important;
            }
            
            .dashboard-container {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .main-content {
                width: calc(100% - 20px) !important;
                max-width: calc(100% - 20px) !important;
                margin: 10px !important;
            }
            
            .table-container,
            .calendar-container,
            .cashflow-container,
            .modal-content {
                max-width: 100% !important;
            }
        }
        
        /* Desktop styles */
        @media screen and (min-width: 769px) {
            .sidebar {
                display: flex !important;
                transform: translateX(0) !important;
                position: fixed;
            }
            
            .mobile-menu-toggle {
                display: none !important;
            }
            
            .main-content {
                margin-left: 270px !important;
                width: calc(100% - 290px) !important;
            }
        }
        
        /* Mobile Responsive Styles */
        @media screen and (max-width: 768px) {
            .sidebar {
                width: 280px;
                transform: translateX(-100%);
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .mobile-menu-toggle {
                display: block;
                position: fixed;
                top: 10px;
                left: 10px;
            }
            
            .dashboard-container {
                margin-left: 0;
            }
            
            .menu-item {
                padding: 16px 20px;
                font-size: 16px;
            }
            
            .menu-item span {
                display: inline;
            }
            
            .main-content {
                margin: 10px;
                margin-left: 10px; /* Reset left margin for mobile */
                padding: 15px;
                width: calc(100% - 20px);
                max-width: 100%;
                overflow-x: hidden;
            }

            .dashboard h1 {
                font-size: 18px;
                margin-left: 0;
                margin-top: 10px;
                padding-left: 50px;
            }
            
            .dashboard-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding-bottom: 15px;
                margin-bottom: 15px;
            }
            
            .logout-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .calendar-controls {
                flex-direction: column;
                gap: 15px;
                margin-bottom: 20px;
            }

            .control-group {
                width: 100%;
            }

            .nav-buttons {
                width: 100%;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .nav-btn {
                width: 100%;
                padding: 12px;
                font-size: 16px;
                border-radius: 8px;
            }

            .calendar-container {
                padding: 10px;
                overflow-x: auto;
                overflow-y: hidden;
                -webkit-overflow-scrolling: touch;
                max-width: 100%;
            }

            .calendar {
                min-width: 100%;
            }

            .calendar th {
                padding: 8px 2px;
                font-size: 11px;
            }

            .calendar td {
                height: 100px;
                min-height: 100px;
                max-height: 100px;
                padding: 5px;
                font-size: 11px;
                vertical-align: top;
            }

            .day-number {
                font-size: 14px;
                margin-bottom: 4px;
                font-weight: bold;
            }

            .day-content {
                font-size: 10px;
                max-height: 70px;
                line-height: 1.3;
            }

            .metric-row {
                font-size: 8px;
            }

            .metric-label {
                font-size: 7px;
            }

            .weekly-total-row {
                font-size: 8px;
                padding: 5px;
            }
            
            .weekly-total-content {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .weekly-label {
                font-size: 8px;
                padding: 1px 4px;
            }
            
            .weekly-total-header {
                flex-wrap: wrap;
                gap: 3px;
            }
            
            .weekly-total-header select,
            .weekly-total-header input {
                font-size: 8px !important;
                padding: 1px 2px !important;
                height: 16px !important;
                min-width: 70px !important;
            }
            
            .weekly-total-metrics {
                font-size: 8px !important;
                gap: 8px;
            }

            .monthly-total {
                font-size: 10px;
            }

            .stats-container {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .stat-card {
                min-width: auto;
                padding: 10px;
            }

            .stat-card h3 {
                font-size: 11px;
            }

            .stat-value {
                font-size: 16px;
            }

            .modal-content {
                width: calc(100% - 20px);
                max-width: 95%;
                margin: 10px;
                padding: 20px;
                max-height: 90vh;
                border-radius: 15px;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
            }

            .modal-header h2 {
                font-size: 18px;
            }

            .expense-item {
                flex-direction: column;
                gap: 5px;
            }

            .expense-category,
            .expense-custom,
            .expense-amount-input {
                width: 100%;
            }

            .yearly-summary-table {
                font-size: 10px;
            }

            .yearly-summary-table th,
            .yearly-summary-table td {
                padding: 5px;
                font-size: 10px;
            }
        }

        @media screen and (max-width: 480px) {
            .dashboard-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .dashboard h1 {
                font-size: 16px;
                margin-left: 0;
                margin-bottom: 10px;
                text-align: center;
            }
            
            .logout-btn {
                width: 100%;
                padding: 12px;
                font-size: 14px;
            }

            .calendar td {
                height: 85px;
                min-height: 85px;
                max-height: 85px;
                padding: 4px;
            }

            .day-content {
                max-height: 40px;
            }

            .stats-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-value {
                font-size: 20px;
            }

            /* Show simplified calendar on very small screens */
            .metric-row:not(:first-child) {
                display: none;
            }

            .calendar-month-year {
                font-size: 18px;
            }
        }

        /* Additional mobile improvements */
        @media screen and (max-width: 768px) {
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-group label {
                font-size: 14px;
                margin-bottom: 8px;
                font-weight: 600;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                width: 100%;
                padding: 14px;
                font-size: 16px;
                border-radius: 8px;
                border: 2px solid #e5e7eb;
            }
            
            .form-group input:focus,
            .form-group select:focus,
            .form-group textarea:focus {
                border-color: #667eea;
                outline: none;
            }
            
            .expense-inputs {
                gap: 15px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .modal-footer {
                padding: 15px 0;
                gap: 10px;
            }
            
            .modal-btn {
                width: 100%;
                padding: 14px;
                font-size: 16px;
                border-radius: 8px;
                font-weight: 600;
            }
            
            select {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23667eea'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 12px center;
                background-size: 20px;
                padding-right: 40px;
                appearance: none;
                -webkit-appearance: none;
            }
        }
        
        /* Touch-friendly buttons for mobile */
        @media (hover: none) and (pointer: coarse) {
            .nav-btn,
            .modal-btn,
            .add-expense-btn,
            .remove-expense-btn,
            .btn,
            .btn-primary,
            .btn-edit,
            .btn-delete {
                min-height: 44px;
                font-size: 14px;
            }
            
            .btn-edit,
            .btn-delete {
                min-height: 36px;
                padding: 8px 12px;
            }

            .calendar td {
                cursor: pointer;
                -webkit-tap-highlight-color: rgba(102, 126, 234, 0.2);
            }

            input[type="number"],
            input[type="text"],
            input[type="password"],
            input[type="date"],
            select,
            textarea {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            
            input[type="date"] {
                padding: 12px;
            }
        }

        /* Improve scrolling on mobile */
        .calendar-container {
            -webkit-overflow-scrolling: touch;
        }

        /* Landscape mode adjustments */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            .modal-content {
                max-height: 90vh;
                margin: 1% auto;
            }

            .calendar td {
                height: 50px;
                min-height: 50px;
                max-height: 50px;
            }
        }

        .calendar-container {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
        }

        .calendar-month-year {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .calendar {
            width: 100%;
            table-layout: fixed;
            border-collapse: separate;
            border-spacing: 5px;
            background: transparent;
        }

        .calendar th {
            padding: 15px 10px;
            background: #667eea;
            color: white;
            font-weight: 600;
            text-align: center;
            border-radius: 5px;
        }

        .calendar td {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 6px;
            height: 120px;
            min-height: 120px;
            max-height: 120px;
            width: 14.28%;
            vertical-align: top;
            position: relative;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
            overflow: hidden;
        }

        .calendar td:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .calendar td.other-month {
            background: #f3f4f6;
            color: #9ca3af;
        }

        .calendar td.today {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }

        .calendar td.holiday {
            background: #fee2e2;
            border: 1px solid #ef4444;
        }

        .calendar td.holiday .day-number {
            color: #dc2626 !important;
            font-weight: bold;
        }

        .holiday-name {
            color: #dc2626;
            font-size: 9px;
            font-weight: bold;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .day-number {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .day-content {
            font-size: 10px;
            color: #4b5563;
            line-height: 1.2;
            overflow-y: auto;
            max-height: 90px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1px;
            line-height: 1.2;
        }

        .metric-label {
            color: #6b7280;
            font-size: 9px;
            min-width: 25px;
        }

        .metric-value {
            font-weight: 500;
            font-size: 9px;
            text-align: right;
        }

        .sales-amount {
            color: #059669;
            font-weight: bold;
        }

        .purchase-amount {
            color: #dc2626;
        }

        .profit-amount {
            color: #2563eb;
        }

        .expense-amount {
            color: #dc2626;
        }

        .expense-section {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .expense-items {
            margin-top: 10px;
        }

        .expense-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .expense-item input {
            flex: 1;
        }

        .expense-item .expense-category {
            flex: 2;
        }

        .expense-item .expense-amount-input {
            flex: 1;
        }

        .add-expense-btn {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }

        .add-expense-btn:hover {
            background: #5a67d8;
        }

        .remove-expense-btn {
            padding: 6px 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-expense-btn:hover {
            background: #dc2626;
        }

        .expense-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        .weekly-total-row {
            background: #fce7f3;
            font-weight: bold;
            border: 2px solid #ec4899;
            padding: 8px;
        }
        
        .weekly-total-content {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 10px;
        }
        
        .weekly-label {
            background: #ec4899;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 10px;
            white-space: nowrap;
        }
        
        .weekly-total-header {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .weekly-total-header select,
        .weekly-total-header input {
            font-size: 9px;
            padding: 1px 4px;
            height: 18px;
            line-height: 1;
            border: 1px solid #ec4899;
            background: white;
        }
        
        .weekly-total-header select {
            min-width: 100px;
        }
        
        .weekly-total-header input {
            min-width: 80px;
        }
        
        .weekly-total-metrics {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .weekly-total-metrics span {
            white-space: nowrap;
        }

        .monthly-total {
            background: #dbeafe;
            font-weight: bold;
            border: 2px solid #3b82f6;
        }

        .day-memo {
            color: #6b7280;
            font-size: 11px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .sunday .day-number {
            color: #ef4444;
        }

        .saturday .day-number {
            color: #3b82f6;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h2 {
            color: #333;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-body .form-group {
            margin-bottom: 0;
        }

        .modal-body input, .modal-body textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .modal-body textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .modal-btn.save {
            background: #10b981;
            color: white;
        }

        .modal-btn.save:hover {
            background: #059669;
        }

        .modal-btn.cancel {
            background: #6b7280;
            color: white;
        }

        .modal-btn.cancel:hover {
            background: #4b5563;
        }

        .message {
            padding: 12px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-value {
            color: #333;
            font-size: 24px;
            font-weight: bold;
        }
    </style>
    <!-- Supabase SDK„ÇíËøΩÂä† -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-sync.js"></script>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <h2>Â£≤‰∏äÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h2>
        <form id="loginForm">
            <div class="form-group">
                <label for="password">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                <input type="password" id="password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" required>
            </div>
            <button type="submit" class="btn">„É≠„Ç∞„Ç§„É≥</button>
        </form>
    </div>

    <div class="dashboard" id="dashboard">
        <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleMobileMenu()">‚ò∞</button>
        <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>
        <div class="dashboard-container">
            <div class="sidebar mobile-closed" id="sidebar">
                <div class="sidebar-header">
                    <span class="sidebar-title">„É°„Éã„É•„Éº</span>
                    <button class="toggle-sidebar" onclick="toggleSidebar()" style="display: none;">‚ò∞</button>
                </div>
                <div class="sidebar-menu">
                    <button class="menu-item active" onclick="showSection('calendar')">
                        <span>Â£≤‰∏äÁÆ°ÁêÜ</span>
                    </button>
                    <button class="menu-item" onclick="showSection('cashflow')">
                        <span>ÂÖ•Âá∫Èáë</span>
                    </button>
                </div>
            </div>
            
            <div class="main-content">
                <div class="content-section active" id="calendar-section">
                    <div class="dashboard-header">
                        <h1>Â£≤‰∏äÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h1>
                        <button class="logout-btn" onclick="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                    </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button class="nav-btn" onclick="openYearlySummary()" style="background: #10b981;">
                üìà Âπ¥ÈñìÂêàË®à„ÇíË¶ã„Çã
            </button>
        </div>

        <div class="calendar-controls">
            <div class="control-group">
                <label for="year">Âπ¥:</label>
                <input type="number" id="year" min="2020" max="2030" value="2025" onchange="updateCalendar()">
            </div>
            <div class="control-group">
                <label for="month">Êúà:</label>
                <select id="month" onchange="updateCalendar()">
                    <option value="1">1Êúà</option>
                    <option value="2">2Êúà</option>
                    <option value="3">3Êúà</option>
                    <option value="4">4Êúà</option>
                    <option value="5">5Êúà</option>
                    <option value="6">6Êúà</option>
                    <option value="7">7Êúà</option>
                    <option value="8">8Êúà</option>
                    <option value="9">9Êúà</option>
                    <option value="10">10Êúà</option>
                    <option value="11">11Êúà</option>
                    <option value="12">12Êúà</option>
                </select>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn" onclick="changeMonth(-1)">‚óÄ ÂâçÊúà</button>
                <button class="nav-btn" onclick="changeMonth(1)">Ê¨°Êúà ‚ñ∂</button>
            </div>
        </div>

        <div class="calendar-container">
            <div class="calendar-month-year" id="calendarTitle"></div>
            <table class="calendar">
                <thead>
                    <tr>
                        <th>Êó•</th>
                        <th>Êúà</th>
                        <th>ÁÅ´</th>
                        <th>Ê∞¥</th>
                        <th>Êú®</th>
                        <th>Èáë</th>
                        <th>Âúü</th>
                    </tr>
                </thead>
                <tbody id="calendarBody">
                </tbody>
            </table>
        </div>


        <div class="stats-container">
            <div class="stat-card">
                <h3>ÊúàÈñìÂ£≤‰∏äÂêàË®à</h3>
                <div class="stat-value" id="monthTotal">¬•0</div>
            </div>
            <div class="stat-card">
                <h3>ÊúàÈñìË≤∑ÂèñÈ°çÂêàË®à</h3>
                <div class="stat-value" id="purchaseTotal">¬•0</div>
            </div>
            <div class="stat-card">
                <h3>ÊúàÈñìÁ≤óÂà©ÁõäÂêàË®à</h3>
                <div class="stat-value" id="profitTotal">¬•0</div>
            </div>
            <div class="stat-card">
                <h3>ÊúàÈñìÁµåË≤ªÂêàË®à</h3>
                <div class="stat-value" id="expenseTotal">¬•0</div>
            </div>
            <div class="stat-card">
                <h3>ÊúàÈñìÂñ∂Ê•≠Âà©Áõä</h3>
                <div class="stat-value" id="operatingProfitTotal" style="font-weight: bold;">¬•0</div>
            </div>
            <div class="stat-card">
                <h3>ÊúàÈñìÊù•Â∫óÊï∞</h3>
                <div class="stat-value" id="visitorsTotal">0‰∫∫</div>
            </div>
            <div class="stat-card">
                <h3>ÊúàÈñìÊàêÁ¥ÑÊï∞</h3>
                <div class="stat-value" id="contractsTotal">0‰ª∂</div>
            </div>
            <div class="stat-card">
                <h3>ÊàêÁ¥ÑÁéá</h3>
                <div class="stat-value" id="conversionRate">0%</div>
            </div>
        </div>

                    <button class="nav-btn" id="backupBtn" style="margin-top: 20px; background: #6b7280;">ÊâãÂãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</button>
                    <button class="nav-btn" id="downloadBtn" style="margin-top: 10px; background: #3b82f6;">„Éá„Éº„Çø„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                    <button class="nav-btn" id="uploadBtn" style="margin-top: 10px; background: #8b5cf6;">„Éá„Éº„Çø„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</button>
                    <button class="nav-btn" onclick="testSupabaseConnection()" style="margin-top: 10px; background: #059669;">SupabaseÊé•Á∂ö„ÉÜ„Çπ„Éà</button>
                    <input type="file" id="fileInput" accept=".json" style="display: none;">
                    <div style="font-size: 12px; color: #10b981; margin-top: 5px; text-align: center;">‚Äª „Éá„Éº„Çø„ÅØËá™Âãï‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åô</div>
                    <div class="message" id="message"></div>
                </div>
                
                <div class="content-section" id="cashflow-section">
                    <div class="dashboard-header">
                        <h1>ÂÖ•Âá∫ÈáëÁÆ°ÁêÜ</h1>
                        <button class="logout-btn" onclick="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                    </div>
                    
                    <div class="cashflow-container">
                        <!-- ÊúàÈÅ∏Êäû„Çª„ÇØ„Ç∑„Éß„É≥ -->
                        <div class="month-selector-section">
                            <div class="month-selector">
                                <div class="form-group" style="order: 1;">
                                    <label for="cashflowYear">Âπ¥</label>
                                    <input type="number" id="cashflowYear" class="form-control" min="2020" max="2030" value="2025" onchange="updateDepositDisplay()">
                                </div>
                                <div class="form-group" style="order: 2;">
                                    <label for="cashflowMonth">Êúà</label>
                                    <select id="cashflowMonth" class="form-control" onchange="updateDepositDisplay()">
                                        <option value="1">1Êúà</option>
                                        <option value="2">2Êúà</option>
                                        <option value="3">3Êúà</option>
                                        <option value="4">4Êúà</option>
                                        <option value="5">5Êúà</option>
                                        <option value="6">6Êúà</option>
                                        <option value="7">7Êúà</option>
                                        <option value="8">8Êúà</option>
                                        <option value="9">9Êúà</option>
                                        <option value="10">10Êúà</option>
                                        <option value="11">11Êúà</option>
                                        <option value="12">12Êúà</option>
                                    </select>
                                </div>
                                <button class="btn-primary" style="order: 3;" onclick="changeDepositMonth(-1)">‚óÄ ÂâçÊúà</button>
                                <button class="btn-primary" style="order: 4;" onclick="changeDepositMonth(1)">Ê¨°Êúà ‚ñ∂</button>
                            </div>
                        </div>

                        <!-- Â∑¶Âè≥ÂàÜÂâ≤„Ç≥„É≥„ÉÜ„Éä -->
                        <!-- ÁôªÈå≤„Éú„Çø„É≥ -->
                        <div style="display: flex; gap: 20px; margin-bottom: 30px; justify-content: center;">
                            <button class="btn-primary" onclick="openDepositModal()" style="background: #10b981; padding: 15px 30px; font-size: 16px; min-width: 150px;">
                                ÂÖ•ÈáëÁôªÈå≤
                            </button>
                            <button class="btn-primary" onclick="openWithdrawModal()" style="background: #ef4444; padding: 15px 30px; font-size: 16px; min-width: 150px;">
                                Âá∫ÈáëÁôªÈå≤
                            </button>
                        </div>
                        <!-- ÂèéÊîØÂÜÖË®≥ -->
                        <div class="cashflow-section summary-section">
                            <h2 class="section-title">ÂèéÊîØÂÜÖË®≥</h2>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <span class="summary-label">ÂÖ•ÈáëÂêàË®à:</span>
                                    <span class="summary-value deposit-amount" id="summaryDeposit">¬•0</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Âá∫ÈáëÂêàË®à:</span>
                                    <span class="summary-value withdraw-amount" id="summaryWithdraw">-¬•0</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">ÂèéÊîØ:</span>
                                    <span class="summary-value" id="summaryBalance">¬•0</span>
                                </div>
                            </div>
                        </div>

                        <div class="cashflow-split-container">
                            <!-- Â∑¶ÂÅ¥ÔºöÂÖ•Èáë -->
                            <div class="cashflow-column">
                                <!-- ÂÖ•ÈáëÂ±•Ê≠¥„ÉÜ„Éº„Éñ„É´ -->
                                <div class="cashflow-section">
                                    <h2 class="section-title"><span id="depositMonthTitle">ÂÖ•ÈáëÂ±•Ê≠¥</span></h2>
                                    <div class="table-container">
                                        <table class="cashflow-table">
                                            <thead>
                                                <tr>
                                                    <th>ÂÖ•ÈáëÊó•</th>
                                                    <th>ÂÖ•ÈáëÈ°ç</th>
                                                    <th>ÂÇôËÄÉ</th>
                                                    <th>Êìç‰Ωú</th>
                                                </tr>
                                            </thead>
                                            <tbody id="depositTableBody">
                                                <!-- ÂÖ•Èáë„Éá„Éº„Çø„ÅåÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                                            </tbody>
                                        </table>
                                        <div id="noDepositData" class="no-data-message">
                                            ÂÖ•Èáë„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                                        </div>
                                    </div>
                                    
                                    <!-- ÂêàË®àË°®Á§∫ -->
                                    <div class="total-section">
                                        <div class="total-item">
                                            <span class="total-label"><span id="depositMonthLabel">ÊúàÈñì</span>ÂÖ•ÈáëÂêàË®à:</span>
                                            <span class="total-value" id="totalDeposit">¬•0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Âè≥ÂÅ¥ÔºöÂá∫Èáë -->
                            <div class="cashflow-column">
                                <!-- Âá∫ÈáëÂ±•Ê≠¥„ÉÜ„Éº„Éñ„É´ -->
                                <div class="cashflow-section">
                                    <h2 class="section-title"><span id="withdrawMonthTitle">Âá∫ÈáëÂ±•Ê≠¥</span></h2>
                                    <div class="table-container">
                                        <table class="cashflow-table">
                                            <thead>
                                                <tr>
                                                    <th>Âá∫ÈáëÊó•</th>
                                                    <th>Âá∫ÈáëÈ°ç</th>
                                                    <th>ÂÇôËÄÉ</th>
                                                    <th>Êìç‰Ωú</th>
                                                </tr>
                                            </thead>
                                            <tbody id="withdrawTableBody">
                                                <!-- Âá∫Èáë„Éá„Éº„Çø„ÅåÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                                            </tbody>
                                        </table>
                                        <div id="noWithdrawData" class="no-data-message">
                                            Âá∫Èáë„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                                        </div>
                                    </div>
                                    
                                    <!-- ÂêàË®àË°®Á§∫ -->
                                    <div class="total-section">
                                        <div class="total-item">
                                            <span class="total-label"><span id="withdrawMonthLabel">ÊúàÈñì</span>Âá∫ÈáëÂêàË®à:</span>
                                            <span class="total-value withdraw-amount" id="totalWithdraw">-¬•0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for yearly summary -->
    <div id="yearlyModal" class="modal">
        <div class="modal-content" style="width: 800px; max-width: 90%;">
            <div class="modal-header">
                <h2>Âπ¥ÈñìÂêàË®à„É¨„Éù„Éº„Éà</h2>
                <span class="close" onclick="closeYearlyModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="yearSelect">Âπ¥„ÇíÈÅ∏Êäû:</label>
                    <select id="yearSelect" onchange="updateYearlySummary()" style="width: 150px; padding: 8px;">
                        <option value="2024">2024Âπ¥</option>
                        <option value="2025" selected>2025Âπ¥</option>
                        <option value="2026">2026Âπ¥</option>
                        <option value="2027">2027Âπ¥</option>
                        <option value="2028">2028Âπ¥</option>
                        <option value="2029">2029Âπ¥</option>
                        <option value="2030">2030Âπ¥</option>
                    </select>
                </div>
                <div id="yearlySummaryContent" style="margin-top: 20px;">
                    <!-- Yearly summary will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for deposit registration -->
    <div id="depositModal" class="modal">
        <div class="modal-content" style="width: 500px; max-width: 90%;">
            <div class="modal-header">
                <h2>ÂÖ•ÈáëÁôªÈå≤</h2>
                <span class="close" onclick="closeDepositModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="modalDepositDate">ÂÖ•ÈáëÊó•</label>
                    <input type="date" id="modalDepositDate" class="form-control">
                </div>
                <div class="form-group">
                    <label for="modalDepositAmount">ÂÖ•ÈáëÈ°ç</label>
                    <input type="number" id="modalDepositAmount" class="form-control" placeholder="‰æã: 100000">
                </div>
                <div class="form-group">
                    <label for="modalDepositNote">ÂÇôËÄÉÔºà‰ªªÊÑèÔºâ</label>
                    <input type="text" id="modalDepositNote" class="form-control" placeholder="„É°„É¢„ÇíÂÖ•Âäõ">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeDepositModal()">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="modal-btn save" onclick="saveDepositFromModal()">ÁôªÈå≤</button>
            </div>
        </div>
    </div>

    <!-- Modal for withdraw registration -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content" style="width: 500px; max-width: 90%;">
            <div class="modal-header">
                <h2>Âá∫ÈáëÁôªÈå≤</h2>
                <span class="close" onclick="closeWithdrawModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="modalWithdrawDate">Âá∫ÈáëÊó•</label>
                    <input type="date" id="modalWithdrawDate" class="form-control">
                </div>
                <div class="form-group">
                    <label for="modalWithdrawAmount">Âá∫ÈáëÈ°ç</label>
                    <input type="number" id="modalWithdrawAmount" class="form-control" placeholder="‰æã: 50000">
                </div>
                <div class="form-group">
                    <label for="modalWithdrawNote">ÂÇôËÄÉÔºà‰ªªÊÑèÔºâ</label>
                    <input type="text" id="modalWithdrawNote" class="form-control" placeholder="„É°„É¢„ÇíÂÖ•Âäõ">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeWithdrawModal()">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="modal-btn save" onclick="saveWithdrawFromModal()">ÁôªÈå≤</button>
            </div>
        </div>
    </div>

    <!-- Modal for editing day data -->
    <div id="dayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Êó•‰ªò„Éá„Éº„ÇøÁ∑®ÈõÜ</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="modalPurchase">Ë≤∑ÂèñÈ°ç</label>
                    <input type="number" id="modalPurchase" placeholder="‰æã: 30000" onchange="calculateSales(); autoSaveModalData();">
                </div>
                <div class="form-group">
                    <label for="modalProfit">Á≤óÂà©Áõä</label>
                    <input type="number" id="modalProfit" placeholder="‰æã: 20000" onchange="calculateSales(); autoSaveModalData();">
                </div>
                <div class="form-group">
                    <label for="modalSales">Â£≤‰∏äÈáëÈ°çÔºàËá™ÂãïË®àÁÆóÔºâ</label>
                    <input type="number" id="modalSales" placeholder="Ëá™ÂãïË®àÁÆó„Åï„Çå„Åæ„Åô" readonly style="background-color: #f0f0f0;">
                </div>
                <div class="form-group">
                    <label for="modalVisitors">Êù•Â∫óÊï∞</label>
                    <input type="number" id="modalVisitors" placeholder="‰æã: 10" min="0" onchange="autoSaveModalData()">
                </div>
                <div class="form-group">
                    <label for="modalContracts">ÊàêÁ¥ÑÊï∞</label>
                    <input type="number" id="modalContracts" placeholder="‰æã: 3" min="0" onchange="autoSaveModalData()">
                </div>
                <div class="form-group">
                    <label for="modalMemo">„É°„É¢</label>
                    <textarea id="modalMemo" placeholder="„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" onchange="autoSaveModalData()"></textarea>
                </div>
                
                <div class="expense-section">
                    <h3 style="margin-bottom: 10px; color: #333;">ÁµåË≤ªÊòéÁ¥∞</h3>
                    <div class="expense-items" id="expenseItems">
                        <!-- Expense items will be added here dynamically -->
                    </div>
                    <button class="add-expense-btn" onclick="addExpenseItem()">+ ÁµåË≤ªÈ†ÖÁõÆ„ÇíËøΩÂä†</button>
                    <div class="expense-total">
                        <span>ÁµåË≤ªÂêàË®à:</span>
                        <span id="expenseTotal" style="color: #dc2626;">¬•0</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeModal()">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="modal-btn save" onclick="saveModalData()">Èñâ„Åò„Çã</button>
                <div style="font-size: 12px; color: #10b981; margin-top: 10px; text-align: center;">
                    ‚Äª ÂÖ•ÂäõÂÜÖÂÆπ„ÅØËá™Âãï‰øùÂ≠ò„Åï„Çå„Åæ„Åô
                </div>
            </div>
        </div>
    </div>

    <script>
        // Password for the dashboard
        const CORRECT_PASSWORD = 'saku11'; // Change this to your desired password
        
        // Current edit date
        let currentEditDate = null;
        
        // Data storage - simplified to single data store
        let calendarData = {};
        let weeklyData = {};
        let depositData = [];
        let withdrawData = [];

        // Function to toggle sidebar (desktop)
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }
        
        // Mobile menu functions
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            if (sidebar.classList.contains('mobile-open')) {
                closeMobileMenu();
            } else {
                sidebar.classList.remove('mobile-closed');
                sidebar.classList.add('mobile-open');
                overlay.classList.add('active');
            }
        }
        
        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.remove('mobile-open');
            sidebar.classList.add('mobile-closed');
            overlay.classList.remove('active');
        }
        
        // Function to show different sections
        function showSection(section) {
            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                closeMobileMenu();
            }
            
            // Remove active class from all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Remove active class from all content sections
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            // Add active class to the menu item for this section
            document.querySelectorAll('.menu-item').forEach(item => {
                if ((section === 'calendar' && item.textContent.includes('Â£≤‰∏äÁÆ°ÁêÜ')) ||
                    (section === 'cashflow' && item.textContent.includes('ÂÖ•Âá∫Èáë'))) {
                    item.classList.add('active');
                }
            });
            
            // Show the selected section
            if (section === 'calendar') {
                document.getElementById('calendar-section').classList.add('active');
            } else if (section === 'cashflow') {
                document.getElementById('cashflow-section').classList.add('active');
            }
        }
        
        // Japanese holidays data (2024-2030)
        const japaneseHolidays = {
            '2024-01-01': 'ÂÖÉÊó•',
            '2024-01-08': 'Êàê‰∫∫„ÅÆÊó•',
            '2024-02-11': 'Âª∫ÂõΩË®òÂøµ„ÅÆÊó•',
            '2024-02-12': 'ÊåØÊõø‰ºëÊó•',
            '2024-02-23': 'Â§©ÁöáË™ïÁîüÊó•',
            '2024-03-20': 'Êò•ÂàÜ„ÅÆÊó•',
            '2024-04-29': 'Êò≠Âíå„ÅÆÊó•',
            '2024-05-03': 'ÊÜ≤Ê≥ïË®òÂøµÊó•',
            '2024-05-04': '„Åø„Å©„Çä„ÅÆÊó•',
            '2024-05-05': '„Åì„Å©„ÇÇ„ÅÆÊó•',
            '2024-05-06': 'ÊåØÊõø‰ºëÊó•',
            '2024-07-15': 'Êµ∑„ÅÆÊó•',
            '2024-08-11': 'Â±±„ÅÆÊó•',
            '2024-08-12': 'ÊåØÊõø‰ºëÊó•',
            '2024-09-16': 'Êï¨ËÄÅ„ÅÆÊó•',
            '2024-09-22': 'ÁßãÂàÜ„ÅÆÊó•',
            '2024-09-23': 'ÊåØÊõø‰ºëÊó•',
            '2024-10-14': '„Çπ„Éù„Éº„ÉÑ„ÅÆÊó•',
            '2024-11-03': 'ÊñáÂåñ„ÅÆÊó•',
            '2024-11-04': 'ÊåØÊõø‰ºëÊó•',
            '2024-11-23': 'Âã§Âä¥ÊÑüË¨ù„ÅÆÊó•',
            
            '2025-01-01': 'ÂÖÉÊó•',
            '2025-01-13': 'Êàê‰∫∫„ÅÆÊó•',
            '2025-02-11': 'Âª∫ÂõΩË®òÂøµ„ÅÆÊó•',
            '2025-02-23': 'Â§©ÁöáË™ïÁîüÊó•',
            '2025-02-24': 'ÊåØÊõø‰ºëÊó•',
            '2025-03-20': 'Êò•ÂàÜ„ÅÆÊó•',
            '2025-04-29': 'Êò≠Âíå„ÅÆÊó•',
            '2025-05-03': 'ÊÜ≤Ê≥ïË®òÂøµÊó•',
            '2025-05-04': '„Åø„Å©„Çä„ÅÆÊó•',
            '2025-05-05': '„Åì„Å©„ÇÇ„ÅÆÊó•',
            '2025-05-06': 'ÊåØÊõø‰ºëÊó•',
            '2025-07-21': 'Êµ∑„ÅÆÊó•',
            '2025-08-11': 'Â±±„ÅÆÊó•',
            '2025-09-15': 'Êï¨ËÄÅ„ÅÆÊó•',
            '2025-09-23': 'ÁßãÂàÜ„ÅÆÊó•',
            '2025-10-13': '„Çπ„Éù„Éº„ÉÑ„ÅÆÊó•',
            '2025-11-03': 'ÊñáÂåñ„ÅÆÊó•',
            '2025-11-23': 'Âã§Âä¥ÊÑüË¨ù„ÅÆÊó•',
            '2025-11-24': 'ÊåØÊõø‰ºëÊó•',
            
            '2026-01-01': 'ÂÖÉÊó•',
            '2026-01-12': 'Êàê‰∫∫„ÅÆÊó•',
            '2026-02-11': 'Âª∫ÂõΩË®òÂøµ„ÅÆÊó•',
            '2026-02-23': 'Â§©ÁöáË™ïÁîüÊó•',
            '2026-03-20': 'Êò•ÂàÜ„ÅÆÊó•',
            '2026-04-29': 'Êò≠Âíå„ÅÆÊó•',
            '2026-05-03': 'ÊÜ≤Ê≥ïË®òÂøµÊó•',
            '2026-05-04': '„Åø„Å©„Çä„ÅÆÊó•',
            '2026-05-05': '„Åì„Å©„ÇÇ„ÅÆÊó•',
            '2026-05-06': 'ÊåØÊõø‰ºëÊó•',
            '2026-07-20': 'Êµ∑„ÅÆÊó•',
            '2026-08-11': 'Â±±„ÅÆÊó•',
            '2026-09-21': 'Êï¨ËÄÅ„ÅÆÊó•',
            '2026-09-22': 'ÊåØÊõø‰ºëÊó•',
            '2026-09-23': 'ÁßãÂàÜ„ÅÆÊó•',
            '2026-10-12': '„Çπ„Éù„Éº„ÉÑ„ÅÆÊó•',
            '2026-11-03': 'ÊñáÂåñ„ÅÆÊó•',
            '2026-11-23': 'Âã§Âä¥ÊÑüË¨ù„ÅÆÊó•',
            
            '2027-01-01': 'ÂÖÉÊó•',
            '2027-01-11': 'Êàê‰∫∫„ÅÆÊó•',
            '2027-02-11': 'Âª∫ÂõΩË®òÂøµ„ÅÆÊó•',
            '2027-02-23': 'Â§©ÁöáË™ïÁîüÊó•',
            '2027-03-21': 'Êò•ÂàÜ„ÅÆÊó•',
            '2027-03-22': 'ÊåØÊõø‰ºëÊó•',
            '2027-04-29': 'Êò≠Âíå„ÅÆÊó•',
            '2027-05-03': 'ÊÜ≤Ê≥ïË®òÂøµÊó•',
            '2027-05-04': '„Åø„Å©„Çä„ÅÆÊó•',
            '2027-05-05': '„Åì„Å©„ÇÇ„ÅÆÊó•',
            '2027-07-19': 'Êµ∑„ÅÆÊó•',
            '2027-08-11': 'Â±±„ÅÆÊó•',
            '2027-09-20': 'Êï¨ËÄÅ„ÅÆÊó•',
            '2027-09-23': 'ÁßãÂàÜ„ÅÆÊó•',
            '2027-10-11': '„Çπ„Éù„Éº„ÉÑ„ÅÆÊó•',
            '2027-11-03': 'ÊñáÂåñ„ÅÆÊó•',
            '2027-11-23': 'Âã§Âä¥ÊÑüË¨ù„ÅÆÊó•',
            
            '2028-01-01': 'ÂÖÉÊó•',
            '2028-01-10': 'Êàê‰∫∫„ÅÆÊó•',
            '2028-02-11': 'Âª∫ÂõΩË®òÂøµ„ÅÆÊó•',
            '2028-02-23': 'Â§©ÁöáË™ïÁîüÊó•',
            '2028-03-20': 'Êò•ÂàÜ„ÅÆÊó•',
            '2028-04-29': 'Êò≠Âíå„ÅÆÊó•',
            '2028-05-03': 'ÊÜ≤Ê≥ïË®òÂøµÊó•',
            '2028-05-04': '„Åø„Å©„Çä„ÅÆÊó•',
            '2028-05-05': '„Åì„Å©„ÇÇ„ÅÆÊó•',
            '2028-07-17': 'Êµ∑„ÅÆÊó•',
            '2028-08-11': 'Â±±„ÅÆÊó•',
            '2028-09-18': 'Êï¨ËÄÅ„ÅÆÊó•',
            '2028-09-22': 'ÁßãÂàÜ„ÅÆÊó•',
            '2028-10-09': '„Çπ„Éù„Éº„ÉÑ„ÅÆÊó•',
            '2028-11-03': 'ÊñáÂåñ„ÅÆÊó•',
            '2028-11-23': 'Âã§Âä¥ÊÑüË¨ù„ÅÆÊó•',
            
            '2029-01-01': 'ÂÖÉÊó•',
            '2029-01-08': 'Êàê‰∫∫„ÅÆÊó•',
            '2029-02-11': 'Âª∫ÂõΩË®òÂøµ„ÅÆÊó•',
            '2029-02-12': 'ÊåØÊõø‰ºëÊó•',
            '2029-02-23': 'Â§©ÁöáË™ïÁîüÊó•',
            '2029-03-20': 'Êò•ÂàÜ„ÅÆÊó•',
            '2029-04-29': 'Êò≠Âíå„ÅÆÊó•',
            '2029-04-30': 'ÊåØÊõø‰ºëÊó•',
            '2029-05-03': 'ÊÜ≤Ê≥ïË®òÂøµÊó•',
            '2029-05-04': '„Åø„Å©„Çä„ÅÆÊó•',
            '2029-05-05': '„Åì„Å©„ÇÇ„ÅÆÊó•',
            '2029-07-16': 'Êµ∑„ÅÆÊó•',
            '2029-08-11': 'Â±±„ÅÆÊó•',
            '2029-09-17': 'Êï¨ËÄÅ„ÅÆÊó•',
            '2029-09-23': 'ÁßãÂàÜ„ÅÆÊó•',
            '2029-09-24': 'ÊåØÊõø‰ºëÊó•',
            '2029-10-08': '„Çπ„Éù„Éº„ÉÑ„ÅÆÊó•',
            '2029-11-03': 'ÊñáÂåñ„ÅÆÊó•',
            '2029-11-23': 'Âã§Âä¥ÊÑüË¨ù„ÅÆÊó•',
            
            '2030-01-01': 'ÂÖÉÊó•',
            '2030-01-14': 'Êàê‰∫∫„ÅÆÊó•',
            '2030-02-11': 'Âª∫ÂõΩË®òÂøµ„ÅÆÊó•',
            '2030-02-23': 'Â§©ÁöáË™ïÁîüÊó•',
            '2030-03-20': 'Êò•ÂàÜ„ÅÆÊó•',
            '2030-04-29': 'Êò≠Âíå„ÅÆÊó•',
            '2030-05-03': 'ÊÜ≤Ê≥ïË®òÂøµÊó•',
            '2030-05-04': '„Åø„Å©„Çä„ÅÆÊó•',
            '2030-05-05': '„Åì„Å©„ÇÇ„ÅÆÊó•',
            '2030-05-06': 'ÊåØÊõø‰ºëÊó•',
            '2030-07-15': 'Êµ∑„ÅÆÊó•',
            '2030-08-11': 'Â±±„ÅÆÊó•',
            '2030-08-12': 'ÊåØÊõø‰ºëÊó•',
            '2030-09-16': 'Êï¨ËÄÅ„ÅÆÊó•',
            '2030-09-23': 'ÁßãÂàÜ„ÅÆÊó•',
            '2030-10-14': '„Çπ„Éù„Éº„ÉÑ„ÅÆÊó•',
            '2030-11-03': 'ÊñáÂåñ„ÅÆÊó•',
            '2030-11-04': 'ÊåØÊõø‰ºëÊó•',
            '2030-11-23': 'Âã§Âä¥ÊÑüË¨ù„ÅÆÊó•'
        };

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('password').value;
            
            if (password === CORRECT_PASSWORD) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadData();
                updateCalendar();
            } else {
                alert('„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                document.getElementById('password').value = '';
            }
        });

        // SupabaseÊé•Á∂ö„ÉÜ„Çπ„ÉàÊ©üËÉΩ
        async function testSupabaseConnection() {
            console.log('=== SupabaseÊé•Á∂ö„ÉÜ„Çπ„ÉàÈñãÂßã ===');
            const results = [];
            
            // 1. SDKË™≠„ÅøËæº„Åø„ÉÅ„Çß„ÉÉ„ÇØ
            if (typeof window.supabase !== 'undefined') {
                results.push('‚úÖ Supabase SDK„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô');
            } else {
                results.push('‚ùå Supabase SDK„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                alert('Supabase SDK„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            
            // 2. ÂàùÊúüÂåñ„ÉÅ„Çß„ÉÉ„ÇØ
            if (typeof supabase !== 'undefined' && supabase) {
                results.push('‚úÖ Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
            } else {
                results.push('‚ùå Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                if (typeof initSupabase === 'function' && initSupabase()) {
                    results.push('‚úÖ Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü');
                } else {
                    results.push('‚ùå Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    alert('Supabase„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
            }
            
            // 3. „É¶„Éº„Ç∂„ÉºIDÁ¢∫Ë™ç
            if (typeof getUserId === 'function') {
                const userId = getUserId();
                results.push(`‚ÑπÔ∏è ‰ΩøÁî®‰∏≠„ÅÆ„É¶„Éº„Ç∂„ÉºID: ${userId}`);
            }
            
            // 4. „ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò
            try {
                if (typeof saveToSupabase === 'function') {
                    const testData = { test: true, timestamp: new Date().toISOString() };
                    const saveResult = await saveToSupabase('test', testData);
                    if (saveResult) {
                        results.push('‚úÖ „ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü');
                    } else {
                        results.push('‚ùå „ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                }
            } catch (error) {
                results.push(`‚ùå ‰øùÂ≠ò„Ç®„É©„Éº: ${error.message}`);
            }
            
            // 5. „ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÅÆÂèñÂæó
            try {
                if (typeof loadFromSupabase === 'function') {
                    const loadResult = await loadFromSupabase('test');
                    if (loadResult) {
                        results.push('‚úÖ „ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü');
                    } else {
                        results.push('‚ö†Ô∏è „ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    }
                }
            } catch (error) {
                results.push(`‚ùå ÂèñÂæó„Ç®„É©„Éº: ${error.message}`);
            }
            
            // ÁµêÊûú„Çí„Ç≥„É≥„ÇΩ„Éº„É´„Å´Ë°®Á§∫
            console.log(results.join('\n'));
            
            // ÁµêÊûú„Çí„Ç¢„É©„Éº„Éà„ÅßË°®Á§∫
            alert('SupabaseÊé•Á∂ö„ÉÜ„Çπ„ÉàÁµêÊûú:\n\n' + results.join('\n') + '\n\nË©≥Á¥∞„ÅØ„Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç≥„É≥„ÇΩ„Éº„É´ÔºàF12„Ç≠„ÉºÔºâ„ÅßÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ');
        }

        function logout() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('password').value = '';
        }

        function changeMonth(direction) {
            const yearInput = document.getElementById('year');
            const monthSelect = document.getElementById('month');
            let year = parseInt(yearInput.value);
            let month = parseInt(monthSelect.value);
            
            month += direction;
            
            if (month > 12) {
                month = 1;
                year++;
            } else if (month < 1) {
                month = 12;
                year--;
            }
            
            yearInput.value = year;
            monthSelect.value = month;
            updateCalendar();
        }

        function updateCalendar() {
            const year = parseInt(document.getElementById('year').value);
            const month = parseInt(document.getElementById('month').value);
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const prevLastDay = new Date(year, month - 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            const daysInPrevMonth = prevLastDay.getDate();
            
            // Update title
            document.getElementById('calendarTitle').textContent = `${year}Âπ¥ ${month}Êúà`;
            
            const tbody = document.getElementById('calendarBody');
            tbody.innerHTML = '';
            
            let date = 1;
            let nextMonthDate = 1;
            
            // Monthly totals
            let monthlyTotals = {
                sales: 0,
                purchase: 0,
                profit: 0,
                visitors: 0,
                contracts: 0,
                expenses: 0,
                deposits: 0
            };
            
            // Always create exactly 6 weeks for consistent layout
            for (let week = 0; week < 6; week++) {
                const row = tbody.insertRow();
                
                // Weekly totals for this row
                let weeklyTotals = {
                    sales: 0,
                    purchase: 0,
                    profit: 0,
                    visitors: 0,
                    contracts: 0,
                    expenses: 0,
                    deposits: 0
                };
                
                for (let day = 0; day < 7; day++) {
                    const cell = row.insertCell();
                    const dayDiv = document.createElement('div');
                    
                    if (week === 0 && day < startDay) {
                        // Previous month dates
                        const prevMonthDay = daysInPrevMonth - startDay + day + 1;
                        dayDiv.className = 'day-number';
                        dayDiv.textContent = prevMonthDay;
                        cell.className = 'other-month';
                        // Calculate correct month and year for previous month
                        const prevMonth = month === 1 ? 12 : month - 1;
                        const prevYear = month === 1 ? year - 1 : year;
                        const prevDateStr = `${prevYear}-${prevMonth.toString().padStart(2, '0')}-${prevMonthDay.toString().padStart(2, '0')}`;
                        cell.onclick = () => openModal(prevDateStr, prevMonthDay, prevMonth, prevYear);
                    } else if (date > daysInMonth) {
                        // Next month dates
                        const nextDay = nextMonthDate++;
                        dayDiv.className = 'day-number';
                        dayDiv.textContent = nextDay;
                        cell.className = 'other-month';
                        // Calculate correct month and year for next month
                        const nextMonth = month === 12 ? 1 : month + 1;
                        const nextYear = month === 12 ? year + 1 : year;
                        const nextDateStr = `${nextYear}-${nextMonth.toString().padStart(2, '0')}-${nextDay.toString().padStart(2, '0')}`;
                        cell.onclick = () => openModal(nextDateStr, nextDay, nextMonth, nextYear);
                    } else {
                        // Current month dates
                        const currentDate = new Date(year, month - 1, date);
                        const dateStr = `${year}-${month.toString().padStart(2, '0')}-${date.toString().padStart(2, '0')}`;
                        
                        dayDiv.className = 'day-number';
                        dayDiv.textContent = date;
                        
                        // Add day of week classes
                        if (day === 0) cell.className = 'sunday';
                        if (day === 6) cell.className = 'saturday';
                        
                        // Check if it's a holiday
                        const holidayName = japaneseHolidays[dateStr];
                        if (holidayName) {
                            cell.classList.add('holiday');
                        }
                        
                        // Check if today
                        const today = new Date();
                        if (year === today.getFullYear() && 
                            month === today.getMonth() + 1 && 
                            date === today.getDate()) {
                            cell.classList.add('today');
                        }
                        
                        // Add content
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'day-content';
                        
                        // Add holiday name if it's a holiday
                        if (holidayName) {
                            const holidayDiv = document.createElement('div');
                            holidayDiv.className = 'holiday-name';
                            holidayDiv.textContent = holidayName;
                            holidayDiv.title = holidayName; // Show full name on hover
                            contentDiv.appendChild(holidayDiv);
                        }
                        
                        // Get all data
                        const purchaseData = getPurchaseData(dateStr);
                        const profitData = getProfitData(dateStr);
                        const salesData = getSalesData(dateStr);
                        const visitorsData = getVisitorsData(dateStr);
                        const contractsData = getContractsData(dateStr);
                        const dayDepositData = getDayDepositTotal(dateStr);
                        
                        // Display metrics
                        if (purchaseData) {
                            const row = document.createElement('div');
                            row.className = 'metric-row';
                            row.innerHTML = `<span class="metric-label">Ë≤∑:</span><span class="purchase-amount">¬•${parseInt(purchaseData).toLocaleString()}</span>`;
                            contentDiv.appendChild(row);
                            weeklyTotals.purchase += parseInt(purchaseData) || 0;
                            monthlyTotals.purchase += parseInt(purchaseData) || 0;
                        }
                        
                        if (profitData) {
                            const row = document.createElement('div');
                            row.className = 'metric-row';
                            row.innerHTML = `<span class="metric-label">Âà©:</span><span class="profit-amount">¬•${parseInt(profitData).toLocaleString()}</span>`;
                            contentDiv.appendChild(row);
                            weeklyTotals.profit += parseInt(profitData) || 0;
                            monthlyTotals.profit += parseInt(profitData) || 0;
                        }
                        
                        if (salesData) {
                            const row = document.createElement('div');
                            row.className = 'metric-row';
                            row.innerHTML = `<span class="metric-label">Â£≤:</span><span class="sales-amount">¬•${parseInt(salesData).toLocaleString()}</span>`;
                            contentDiv.appendChild(row);
                            weeklyTotals.sales += parseInt(salesData) || 0;
                            monthlyTotals.sales += parseInt(salesData) || 0;
                        }
                        
                        if (visitorsData || contractsData) {
                            const row = document.createElement('div');
                            row.className = 'metric-row';
                            row.innerHTML = `<span class="metric-label">Êù•/Á¥Ñ:</span><span>${visitorsData || 0}/${contractsData || 0}</span>`;
                            contentDiv.appendChild(row);
                            weeklyTotals.visitors += parseInt(visitorsData) || 0;
                            weeklyTotals.contracts += parseInt(contractsData) || 0;
                            monthlyTotals.visitors += parseInt(visitorsData) || 0;
                            monthlyTotals.contracts += parseInt(contractsData) || 0;
                        }
                        
                        // Display expense total
                        const expenseTotal = getExpenseTotal(dateStr);
                        if (expenseTotal > 0) {
                            const row = document.createElement('div');
                            row.className = 'metric-row';
                            row.innerHTML = `<span class="metric-label">ÁµåË≤ª:</span><span class="expense-amount">¬•${expenseTotal.toLocaleString()}</span>`;
                            contentDiv.appendChild(row);
                            weeklyTotals.expenses += expenseTotal;
                            monthlyTotals.expenses += expenseTotal;
                        }

                        // Display deposit total
                        if (dayDepositData > 0) {
                            const row = document.createElement('div');
                            row.className = 'metric-row calendar-deposit';
                            row.innerHTML = `<span class="metric-label">ÂÖ•Èáë:</span><span>¬•${dayDepositData.toLocaleString()}</span>`;
                            contentDiv.appendChild(row);
                            weeklyTotals.deposits += dayDepositData;
                            monthlyTotals.deposits += dayDepositData;
                        }
                        
                        cell.appendChild(dayDiv);
                        cell.appendChild(contentDiv);
                        
                        // Add click event
                        cell.onclick = () => openModal(dateStr, date, month, year);
                        
                        date++;
                    }
                    
                    // Ensure day div is always appended for all cells
                    if (!cell.contains(dayDiv)) {
                        cell.appendChild(dayDiv);
                    }
                }
                
                // Create weekly total row after each week
                const weekTotalRow = tbody.insertRow();
                const weekTotalCell = weekTotalRow.insertCell();
                weekTotalCell.colSpan = 7; // Span across all 7 days
                weekTotalCell.className = 'weekly-total-row';
                const weekId = `week-${year}-${month}-${week}`;
                const weekData = getWeekData(weekId);
                
                // Always create week total cell for all 6 weeks
                if (true) {
                    const operatingProfit = weeklyTotals.profit - weeklyTotals.expenses;
                    const prefectures = [
                        'ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'ÂåóÊµ∑ÈÅì', 'ÈùíÊ£Æ', 'Â≤©Êâã', 'ÂÆÆÂüé', 'ÁßãÁî∞', 'Â±±ÂΩ¢', 'Á¶èÂ≥∂',
                        'Ëå®Âüé', 'Ê†ÉÊú®', 'Áæ§È¶¨', 'ÂüºÁéâ', 'ÂçÉËëâ', 'Êù±‰∫¨', 'Á•ûÂ•àÂ∑ù',
                        'Êñ∞ÊΩü', 'ÂØåÂ±±', 'Áü≥Â∑ù', 'Á¶è‰∫ï', 'Â±±Ê¢®', 'Èï∑Èáé', 'Â≤êÈòú',
                        'ÈùôÂ≤°', 'ÊÑõÁü•', '‰∏âÈáç', 'ÊªãË≥Ä', '‰∫¨ÈÉΩ', 'Â§ßÈò™', 'ÂÖµÂ∫´',
                        'Â•àËâØ', 'ÂíåÊ≠åÂ±±', 'È≥•Âèñ', 'Â≥∂Ê†π', 'Â≤°Â±±', 'Â∫ÉÂ≥∂', 'Â±±Âè£',
                        'Âæ≥Â≥∂', 'È¶ôÂ∑ù', 'ÊÑõÂ™õ', 'È´òÁü•', 'Á¶èÂ≤°', '‰ΩêË≥Ä', 'Èï∑Â¥é',
                        'ÁÜäÊú¨', 'Â§ßÂàÜ', 'ÂÆÆÂ¥é', 'ÈπøÂÖêÂ≥∂', 'Ê≤ñÁ∏Ñ'
                    ];
                    
                    let prefectureOptions = '';
                    prefectures.forEach(pref => {
                        const selected = weekData.prefecture === pref ? 'selected' : '';
                        prefectureOptions += `<option value="${pref}" ${selected}>${pref}</option>`;
                    });
                    
                    weekTotalCell.innerHTML = `
                        <div class="weekly-total-content">
                            <span class="weekly-label">ÈÄ±Ë®à</span>
                            <div class="weekly-total-header">
                                <select class="week-prefecture" data-week="${weekId}">
                                    ${prefectureOptions}
                                </select>
                                <input type="text" class="week-store" data-week="${weekId}" placeholder="Â∫óËàóÂêç" value="${weekData.store || ''}">
                            </div>
                            ${(weeklyTotals.sales > 0 || weeklyTotals.purchase > 0 || weeklyTotals.profit > 0 || weeklyTotals.expenses > 0) ? `
                                <div class="weekly-total-metrics">
                                    ${weeklyTotals.purchase > 0 ? `<span>Ë≤∑: ¬•${weeklyTotals.purchase.toLocaleString()}</span>` : ''}
                                    ${weeklyTotals.profit > 0 ? `<span>Âà©: ¬•${weeklyTotals.profit.toLocaleString()}</span>` : ''}
                                    ${weeklyTotals.sales > 0 ? `<span>Â£≤: ¬•${weeklyTotals.sales.toLocaleString()}</span>` : ''}
                                    ${weeklyTotals.expenses > 0 ? `<span>Áµå: ¬•${weeklyTotals.expenses.toLocaleString()}</span>` : ''}
                                    ${(weeklyTotals.profit > 0 || weeklyTotals.expenses > 0) ? `<span style="font-weight: bold; color: ${operatingProfit >= 0 ? '#059669' : '#dc2626'};">Âñ∂Ê•≠Âà©Áõä: ¬•${operatingProfit.toLocaleString()}</span>` : ''}
                                    ${(weeklyTotals.visitors > 0 || weeklyTotals.contracts > 0) ? `<span>Êù•/Á¥Ñ: ${weeklyTotals.visitors}/${weeklyTotals.contracts}</span>` : ''}
                                </div>
                            ` : '<div class="weekly-total-metrics"><span>-</span></div>'}
                        </div>
                    `;
                    
                    // Add event listeners after innerHTML
                    setTimeout(() => {
                        const prefectureSelect = weekTotalCell.querySelector('.week-prefecture');
                        const storeInput = weekTotalCell.querySelector('.week-store');
                        
                        if (prefectureSelect) {
                            prefectureSelect.addEventListener('change', function() {
                                saveWeekData(this.dataset.week, 'prefecture', this.value);
                                showAutoSaveIndicator();
                            });
                        }
                        
                        if (storeInput) {
                            storeInput.addEventListener('change', function() {
                                saveWeekData(this.dataset.week, 'store', this.value);
                                showAutoSaveIndicator();
                            });
                        }
                    }, 100);
                }
                
                // Always show all 6 weeks for consistency
                // Don't hide any rows
            }
            
            // Update monthly stats cards
            document.getElementById('monthTotal').textContent = `¬•${monthlyTotals.sales.toLocaleString()}`;
            document.getElementById('purchaseTotal').textContent = `¬•${monthlyTotals.purchase.toLocaleString()}`;
            document.getElementById('profitTotal').textContent = `¬•${monthlyTotals.profit.toLocaleString()}`;
            document.getElementById('expenseTotal').textContent = `¬•${monthlyTotals.expenses.toLocaleString()}`;
            
            const monthlyOperatingProfitForStats = monthlyTotals.profit - monthlyTotals.expenses;
            const operatingProfitEl = document.getElementById('operatingProfitTotal');
            if (operatingProfitEl) {
                operatingProfitEl.textContent = `¬•${monthlyOperatingProfitForStats.toLocaleString()}`;
                operatingProfitEl.style.color = monthlyOperatingProfitForStats >= 0 ? '#059669' : '#dc2626';
            }
            
            // Monthly total row removed as requested
            
            updateStats();
        }

        function getSalesData(dateStr) {
            return calendarData[dateStr]?.sales || '';
        }

        function getMemoData(dateStr) {
            return calendarData[dateStr]?.memo || '';
        }

        function getPurchaseData(dateStr) {
            return calendarData[dateStr]?.purchase || '';
        }

        function getProfitData(dateStr) {
            return calendarData[dateStr]?.profit || '';
        }

        function getVisitorsData(dateStr) {
            return calendarData[dateStr]?.visitors || '';
        }

        function getContractsData(dateStr) {
            return calendarData[dateStr]?.contracts || '';
        }

        function getExpensesData(dateStr) {
            return calendarData[dateStr]?.expenses || [];
        }

        function calculateSales() {
            const purchase = parseInt(document.getElementById('modalPurchase').value) || 0;
            const profit = parseInt(document.getElementById('modalProfit').value) || 0;
            const sales = purchase + profit;
            document.getElementById('modalSales').value = sales > 0 ? sales : '';
        }

        function addExpenseItem(name = '', amount = '') {
            const expenseItems = document.getElementById('expenseItems');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'expense-item';
            
            // Check if name is one of the predefined categories
            const predefinedCategories = ['ÂÆøÊ≥ä‰ª£', 'Âá∫Â∫óÊñô', '„ÉÅ„É©„Ç∑', 'Ë≤©‰øÉÂìÅ', '‰∫§ÈÄöË≤ª', 'È£≤È£üË≤ª'];
            const isCustom = name && !predefinedCategories.includes(name);
            
            itemDiv.innerHTML = `
                <select class="expense-category" onchange="handleCategoryChange(this); autoSaveModalData();" style="flex: 2;">
                    <option value="">È†ÖÁõÆ„ÇíÈÅ∏Êäû</option>
                    <option value="ÂÆøÊ≥ä‰ª£" ${name === 'ÂÆøÊ≥ä‰ª£' ? 'selected' : ''}>ÂÆøÊ≥ä‰ª£</option>
                    <option value="Âá∫Â∫óÊñô" ${name === 'Âá∫Â∫óÊñô' ? 'selected' : ''}>Âá∫Â∫óÊñô</option>
                    <option value="„ÉÅ„É©„Ç∑" ${name === '„ÉÅ„É©„Ç∑' ? 'selected' : ''}>„ÉÅ„É©„Ç∑</option>
                    <option value="Ë≤©‰øÅÂìÅ" ${name === 'Ë≤©‰øÅÂìÅ' ? 'selected' : ''}>Ë≤©‰øÅÂìÅ</option>
                    <option value="‰∫§ÈÄöË≤ª" ${name === '‰∫§ÈÄöË≤ª' ? 'selected' : ''}>‰∫§ÈÄöË≤ª</option>
                    <option value="È£≤È£üË≤ª" ${name === 'È£≤È£üË≤ª' ? 'selected' : ''}>È£≤È£üË≤ª</option>
                    <option value="custom" ${isCustom ? 'selected' : ''}>„Åù„ÅÆ‰ªñÔºàÂÖ•ÂäõÔºâ</option>
                </select>
                <input type="text" class="expense-custom" placeholder="È†ÖÁõÆÂêç„ÇíÂÖ•Âäõ" value="${isCustom ? name : ''}" 
                       style="flex: 2; display: ${isCustom ? 'block' : 'none'};" onchange="calculateExpenseTotal(); autoSaveModalData();">
                <input type="number" class="expense-amount-input" placeholder="ÈáëÈ°ç" value="${amount}" onchange="calculateExpenseTotal(); autoSaveModalData();">
                <button class="remove-expense-btn" onclick="removeExpenseItem(this); autoSaveModalData();">ÂâäÈô§</button>
            `;
            expenseItems.appendChild(itemDiv);
            calculateExpenseTotal();
        }
        
        function handleCategoryChange(select) {
            const itemDiv = select.parentElement;
            const customInput = itemDiv.querySelector('.expense-custom');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                select.style.display = 'none';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                select.style.display = 'block';
                customInput.value = '';
            }
            calculateExpenseTotal();
        }

        function removeExpenseItem(button) {
            button.parentElement.remove();
            calculateExpenseTotal();
        }

        function calculateExpenseTotal() {
            const expenseItems = document.querySelectorAll('.expense-item');
            let total = 0;
            expenseItems.forEach(item => {
                const amount = parseInt(item.querySelector('.expense-amount-input').value) || 0;
                total += amount;
            });
            document.getElementById('expenseTotal').textContent = `¬•${total.toLocaleString()}`;
        }

        function loadExpenses(expenses) {
            const expenseItems = document.getElementById('expenseItems');
            expenseItems.innerHTML = '';
            
            if (expenses && expenses.length > 0) {
                expenses.forEach(expense => {
                    addExpenseItem(expense.name, expense.amount);
                });
            } else {
                // Add one empty expense item by default
                addExpenseItem();
            }
        }

        function saveExpenses() {
            const expenseItems = document.querySelectorAll('.expense-item');
            const expenses = [];
            
            expenseItems.forEach(item => {
                const categorySelect = item.querySelector('.expense-category');
                const customInput = item.querySelector('.expense-custom');
                const amount = item.querySelector('.expense-amount-input').value;
                
                let name = '';
                if (categorySelect.value === 'custom') {
                    name = customInput.value;
                } else if (categorySelect.value) {
                    name = categorySelect.value;
                }
                
                if (name || amount) {
                    expenses.push({ name, amount });
                }
            });
            
            return expenses;
        }

        function getExpenseTotal(dateStr) {
            const expenses = getExpensesData(dateStr);
            let total = 0;
            if (expenses && expenses.length > 0) {
                expenses.forEach(expense => {
                    total += parseInt(expense.amount) || 0;
                });
            }
            return total;
        }

        function openModal(dateStr, day, month, year) {
            currentEditDate = dateStr;
            const modal = document.getElementById('dayModal');
            const modalTitle = document.getElementById('modalTitle');
            
            modalTitle.textContent = `${year}Âπ¥${month}Êúà${day}Êó•„ÅÆ„Éá„Éº„Çø`;
            
            // Load all data
            document.getElementById('modalPurchase').value = getPurchaseData(dateStr);
            document.getElementById('modalProfit').value = getProfitData(dateStr);
            document.getElementById('modalSales').value = getSalesData(dateStr);
            document.getElementById('modalVisitors').value = getVisitorsData(dateStr);
            document.getElementById('modalContracts').value = getContractsData(dateStr);
            document.getElementById('modalMemo').value = getMemoData(dateStr);
            
            // Load expenses
            const expenses = getExpensesData(dateStr);
            loadExpenses(expenses);
            
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('dayModal').style.display = 'none';
            currentEditDate = null;
        }

        function saveModalData() {
            if (!currentEditDate) return;
            
            const purchase = document.getElementById('modalPurchase').value;
            const profit = document.getElementById('modalProfit').value;
            const sales = document.getElementById('modalSales').value;
            const visitors = document.getElementById('modalVisitors').value;
            const contracts = document.getElementById('modalContracts').value;
            const memo = document.getElementById('modalMemo').value;
            const expenses = saveExpenses();
            
            if (!calendarData[currentEditDate]) {
                calendarData[currentEditDate] = {};
            }
            
            calendarData[currentEditDate].purchase = purchase;
            calendarData[currentEditDate].profit = profit;
            calendarData[currentEditDate].sales = sales;
            calendarData[currentEditDate].visitors = visitors;
            calendarData[currentEditDate].contracts = contracts;
            calendarData[currentEditDate].memo = memo;
            calendarData[currentEditDate].expenses = expenses;
            
            closeModal();
            updateCalendar();
        }
        
        // Auto-save function for modal
        function autoSaveModalData() {
            if (!currentEditDate) return;
            
            const purchase = document.getElementById('modalPurchase').value;
            const profit = document.getElementById('modalProfit').value;
            const sales = document.getElementById('modalSales').value;
            const visitors = document.getElementById('modalVisitors').value;
            const contracts = document.getElementById('modalContracts').value;
            const memo = document.getElementById('modalMemo').value;
            const expenses = saveExpenses();
            
            if (!calendarData[currentEditDate]) {
                calendarData[currentEditDate] = {};
            }
            
            calendarData[currentEditDate].purchase = purchase;
            calendarData[currentEditDate].profit = profit;
            calendarData[currentEditDate].sales = sales;
            calendarData[currentEditDate].visitors = visitors;
            calendarData[currentEditDate].contracts = contracts;
            calendarData[currentEditDate].memo = memo;
            calendarData[currentEditDate].expenses = expenses;
            
            // Save to localStorage
            localStorage.setItem('calendarData', JSON.stringify(calendarData));
            
            // Update calendar without closing modal
            const year = parseInt(document.getElementById('year').value);
            const month = parseInt(document.getElementById('month').value);
            updateCalendarQuietly();
            
            // Show brief save indicator
            showAutoSaveIndicator();
        }
        
        function updateCalendarQuietly() {
            // Update calendar without closing modal
            const currentScrollPos = document.querySelector('.calendar-container').scrollTop;
            updateCalendar();
            document.querySelector('.calendar-container').scrollTop = currentScrollPos;
        }
        
        function showAutoSaveIndicator() {
            // Create or update auto-save indicator
            let indicator = document.getElementById('autoSaveIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'autoSaveIndicator';
                indicator.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #10b981; color: white; padding: 8px 15px; border-radius: 5px; font-size: 12px; z-index: 10000; display: none;';
                indicator.textContent = '‚úì Ëá™Âãï‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü';
                document.body.appendChild(indicator);
            }
            
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        function updateStats() {
            const year = parseInt(document.getElementById('year').value);
            const month = parseInt(document.getElementById('month').value);
            
            let salesTotal = 0;
            let purchaseTotal = 0;
            let profitTotal = 0;
            let visitorsTotal = 0;
            let contractsTotal = 0;
            let expensesTotal = 0;
            
            for (const [dateStr, data] of Object.entries(calendarData)) {
                const [y, m] = dateStr.split('-').map(Number);
                if (y === year && m === month) {
                    salesTotal += parseInt(data.sales) || 0;
                    purchaseTotal += parseInt(data.purchase) || 0;
                    profitTotal += parseInt(data.profit) || 0;
                    visitorsTotal += parseInt(data.visitors) || 0;
                    contractsTotal += parseInt(data.contracts) || 0;
                    
                    // Calculate expense total for this date
                    if (data.expenses && data.expenses.length > 0) {
                        data.expenses.forEach(expense => {
                            expensesTotal += parseInt(expense.amount) || 0;
                        });
                    }
                }
            }
            
            const conversionRate = visitorsTotal > 0 ? Math.round((contractsTotal / visitorsTotal) * 100) : 0;
            const operatingProfit = profitTotal - expensesTotal;
            
            document.getElementById('monthTotal').textContent = `¬•${salesTotal.toLocaleString()}`;
            document.getElementById('purchaseTotal').textContent = `¬•${purchaseTotal.toLocaleString()}`;
            document.getElementById('profitTotal').textContent = `¬•${profitTotal.toLocaleString()}`;
            document.getElementById('expenseTotal').textContent = `¬•${expensesTotal.toLocaleString()}`;
            
            const operatingProfitEl = document.getElementById('operatingProfitTotal');
            operatingProfitEl.textContent = `¬•${operatingProfit.toLocaleString()}`;
            operatingProfitEl.style.color = operatingProfit >= 0 ? '#059669' : '#dc2626';
            
            document.getElementById('visitorsTotal').textContent = `${visitorsTotal}‰∫∫`;
            document.getElementById('contractsTotal').textContent = `${contractsTotal}‰ª∂`;
            document.getElementById('conversionRate').textContent = `${conversionRate}%`;
        }

        function saveAllData() {
            try {
                const timestamp = new Date().toISOString();
                
                localStorage.setItem('calendarData', JSON.stringify(calendarData));
                localStorage.setItem('calendarDataUpdated', timestamp);
                
                localStorage.setItem('weeklyData', JSON.stringify(weeklyData));
                localStorage.setItem('weeklyDataUpdated', timestamp);
                
                localStorage.setItem('depositData', JSON.stringify(depositData));
                localStorage.setItem('depositDataUpdated', timestamp);
                
                localStorage.setItem('withdrawData', JSON.stringify(withdrawData));
                localStorage.setItem('withdrawDataUpdated', timestamp);
                
                // Supabase„Å´ÂêåÊúüÔºàË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
                if (typeof saveToSupabase === 'function' && supabase) {
                    saveToSupabase('calendar', calendarData);
                    saveToSupabase('weekly', weeklyData);
                    saveToSupabase('deposit', depositData);
                    saveToSupabase('withdraw', withdrawData);
                }
                
                showMessage('„Éá„Éº„Çø„Çí„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                showAutoSaveIndicator();
            } catch (error) {
                console.error('Save error:', error);
                showMessage('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        // „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊ©üËÉΩ
        function downloadData() {
            const data = {
                calendarData: calendarData,
                weeklyData: weeklyData,
                depositData: depositData,
                withdrawData: withdrawData,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sales-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('„Éá„Éº„Çø„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
        }
        
        // „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ©üËÉΩ
        function uploadData(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.calendarData) {
                        calendarData = data.calendarData;
                        localStorage.setItem('calendarData', JSON.stringify(calendarData));
                    }
                    if (data.weeklyData) {
                        weeklyData = data.weeklyData;
                        localStorage.setItem('weeklyData', JSON.stringify(weeklyData));
                    }
                    if (data.depositData) {
                        depositData = data.depositData;
                        localStorage.setItem('depositData', JSON.stringify(depositData));
                    }
                    if (data.withdrawData) {
                        withdrawData = data.withdrawData;
                        localStorage.setItem('withdrawData', JSON.stringify(withdrawData));
                    }
                    
                    // ÁîªÈù¢„ÇíÊõ¥Êñ∞
                    updateCalendar();
                    updateDepositTable();
                    updateWithdrawTable();
                    updateStats();
                    
                    showMessage('„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü', 'success');
                } catch (error) {
                    console.error('Upload error:', error);
                    showMessage('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            };
            reader.readAsText(file);
        }

        function loadData() {
            const savedData = localStorage.getItem('calendarData');
            if (savedData) {
                calendarData = JSON.parse(savedData);
            }
            const savedWeeklyData = localStorage.getItem('weeklyData');
            if (savedWeeklyData) {
                weeklyData = JSON.parse(savedWeeklyData);
            }
            const savedDepositData = localStorage.getItem('depositData');
            if (savedDepositData) {
                depositData = JSON.parse(savedDepositData);
                updateDepositTable();
            }
            const savedWithdrawData = localStorage.getItem('withdrawData');
            if (savedWithdrawData) {
                withdrawData = JSON.parse(savedWithdrawData);
                updateWithdrawTable();
            }
        }
        
        function getWeekData(weekId) {
            return weeklyData[weekId] || { prefecture: '', store: '' };
        }
        
        function saveWeekData(weekId, field, value) {
            if (!weeklyData[weekId]) {
                weeklyData[weekId] = {};
            }
            weeklyData[weekId][field] = value;
            localStorage.setItem('weeklyData', JSON.stringify(weeklyData));
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = 'message ' + type;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }

        // Yearly summary functions
        function openYearlySummary() {
            const modal = document.getElementById('yearlyModal');
            const currentYear = new Date().getFullYear();
            document.getElementById('yearSelect').value = currentYear;
            updateYearlySummary();
            modal.style.display = 'block';
        }

        function closeYearlyModal() {
            document.getElementById('yearlyModal').style.display = 'none';
        }

        function updateYearlySummary() {
            const year = parseInt(document.getElementById('yearSelect').value);
            const months = ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'];
            
            let yearlyTotals = {
                sales: 0,
                purchase: 0,
                profit: 0,
                expenses: 0,
                visitors: 0,
                contracts: 0
            };
            
            let monthlyData = [];
            
            // Calculate monthly totals
            for (let month = 1; month <= 12; month++) {
                let monthData = {
                    month: months[month - 1],
                    sales: 0,
                    purchase: 0,
                    profit: 0,
                    expenses: 0,
                    visitors: 0,
                    contracts: 0
                };
                
                for (const [dateStr, data] of Object.entries(calendarData)) {
                    const [y, m] = dateStr.split('-').map(Number);
                    if (y === year && m === month) {
                        monthData.sales += parseInt(data.sales) || 0;
                        monthData.purchase += parseInt(data.purchase) || 0;
                        monthData.profit += parseInt(data.profit) || 0;
                        monthData.visitors += parseInt(data.visitors) || 0;
                        monthData.contracts += parseInt(data.contracts) || 0;
                        
                        if (data.expenses && data.expenses.length > 0) {
                            data.expenses.forEach(expense => {
                                monthData.expenses += parseInt(expense.amount) || 0;
                            });
                        }
                    }
                }
                
                monthData.operatingProfit = monthData.profit - monthData.expenses;
                monthData.conversionRate = monthData.visitors > 0 ? Math.round((monthData.contracts / monthData.visitors) * 100) : 0;
                monthData.purchaseRate = monthData.sales > 0 ? Math.round((monthData.purchase / monthData.sales) * 100) : 0;
                
                monthlyData.push(monthData);
                
                // Add to yearly totals
                yearlyTotals.sales += monthData.sales;
                yearlyTotals.purchase += monthData.purchase;
                yearlyTotals.profit += monthData.profit;
                yearlyTotals.expenses += monthData.expenses;
                yearlyTotals.visitors += monthData.visitors;
                yearlyTotals.contracts += monthData.contracts;
            }
            
            yearlyTotals.operatingProfit = yearlyTotals.profit - yearlyTotals.expenses;
            yearlyTotals.conversionRate = yearlyTotals.visitors > 0 ? Math.round((yearlyTotals.contracts / yearlyTotals.visitors) * 100) : 0;
            yearlyTotals.purchaseRate = yearlyTotals.sales > 0 ? Math.round((yearlyTotals.purchase / yearlyTotals.sales) * 100) : 0;
            
            // Generate HTML
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">${year}Âπ¥ Â£≤‰∏ä„Çµ„Éû„É™„Éº</h3>
                    <div style="font-size: 16px; font-weight: bold; color: ${yearlyTotals.operatingProfit >= 0 ? '#059669' : '#dc2626'};">
                        Âπ¥ÈñìÂñ∂Ê•≠Âà©Áõä: ¬•${yearlyTotals.operatingProfit.toLocaleString()}
                    </div>
                </div>
                <table class="yearly-summary-table">
                    <thead>
                        <tr>
                            <th>Êúà</th>
                            <th>Â£≤‰∏ä</th>
                            <th>Ë≤∑ÂèñÈ°ç</th>
                            <th>Ë≤∑ÂèñÁéá</th>
                            <th>Á≤óÂà©Áõä</th>
                            <th>ÁµåË≤ª</th>
                            <th>Âñ∂Ê•≠Âà©Áõä</th>
                            <th>Êù•Â∫óÊï∞</th>
                            <th>ÊàêÁ¥ÑÊï∞</th>
                            <th>ÊàêÁ¥ÑÁéá</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            monthlyData.forEach(data => {
                const profitClass = data.operatingProfit >= 0 ? 'profit-positive' : 'profit-negative';
                html += `
                    <tr>
                        <td>${data.month}</td>
                        <td>¬•${data.sales.toLocaleString()}</td>
                        <td>¬•${data.purchase.toLocaleString()}</td>
                        <td>${data.purchaseRate}%</td>
                        <td>¬•${data.profit.toLocaleString()}</td>
                        <td>¬•${data.expenses.toLocaleString()}</td>
                        <td class="${profitClass}">¬•${data.operatingProfit.toLocaleString()}</td>
                        <td>${data.visitors}‰∫∫</td>
                        <td>${data.contracts}‰ª∂</td>
                        <td>${data.conversionRate}%</td>
                    </tr>
                `;
            });
            
            const yearlyProfitClass = yearlyTotals.operatingProfit >= 0 ? 'profit-positive' : 'profit-negative';
            html += `
                    <tr class="yearly-total-row">
                        <td>Âπ¥ÈñìÂêàË®à</td>
                        <td>¬•${yearlyTotals.sales.toLocaleString()}</td>
                        <td>¬•${yearlyTotals.purchase.toLocaleString()}</td>
                        <td>${yearlyTotals.purchaseRate}%</td>
                        <td>¬•${yearlyTotals.profit.toLocaleString()}</td>
                        <td>¬•${yearlyTotals.expenses.toLocaleString()}</td>
                        <td class="${yearlyProfitClass}">¬•${yearlyTotals.operatingProfit.toLocaleString()}</td>
                        <td>${yearlyTotals.visitors}‰∫∫</td>
                        <td>${yearlyTotals.contracts}‰ª∂</td>
                        <td>${yearlyTotals.conversionRate}%</td>
                    </tr>
                </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px;">Âπ¥Èñì„Çµ„Éû„É™„Éº</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>ÊúàÂπ≥ÂùáÂ£≤‰∏ä: ¬•${Math.round(yearlyTotals.sales / 12).toLocaleString()}</div>
                        <div>ÊúàÂπ≥ÂùáË≤∑ÂèñÈ°ç: ¬•${Math.round(yearlyTotals.purchase / 12).toLocaleString()}</div>
                        <div>ÊúàÂπ≥ÂùáÁ≤óÂà©Áõä: ¬•${Math.round(yearlyTotals.profit / 12).toLocaleString()}</div>
                        <div style="color: ${yearlyTotals.operatingProfit >= 0 ? '#059669' : '#dc2626'}; font-weight: bold;">
                            ÊúàÂπ≥ÂùáÂñ∂Ê•≠Âà©Áõä: ¬•${Math.round(yearlyTotals.operatingProfit / 12).toLocaleString()}
                            ${yearlyTotals.operatingProfit < 0 ? 'ÔºàËµ§Â≠óÔºâ' : ''}
                        </div>
                        <div style="color: ${yearlyTotals.operatingProfit >= 0 ? 'inherit' : '#dc2626'};">
                            Âπ¥ÈñìÂñ∂Ê•≠Âà©ÁõäÁéá: ${yearlyTotals.sales > 0 ? Math.round((yearlyTotals.operatingProfit / yearlyTotals.sales) * 100) : 0}%
                        </div>
                        <div style="color: ${yearlyTotals.purchaseRate > 70 ? '#dc2626' : yearlyTotals.purchaseRate > 50 ? '#f59e0b' : '#059669'}; font-weight: bold;">
                            Âπ¥ÈñìË≤∑ÂèñÁéá: ${yearlyTotals.purchaseRate}%
                        </div>
                        <div>Âπ¥ÈñìÊàêÁ¥ÑÁéá: ${yearlyTotals.conversionRate}%</div>
                    </div>
                </div>
            `;
            
            document.getElementById('yearlySummaryContent').innerHTML = html;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const dayModal = document.getElementById('dayModal');
            const yearlyModal = document.getElementById('yearlyModal');
            if (event.target === dayModal) {
                closeModal();
            } else if (event.target === yearlyModal) {
                closeYearlyModal();
            }
        }

        // Modal functions for deposit and withdraw
        function openDepositModal() {
            const modal = document.getElementById('depositModal');
            modal.style.display = 'block';
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('modalDepositDate').value = today;
            document.getElementById('modalDepositAmount').value = '';
            document.getElementById('modalDepositNote').value = '';
        }
        
        function closeDepositModal() {
            document.getElementById('depositModal').style.display = 'none';
        }
        
        function openWithdrawModal() {
            const modal = document.getElementById('withdrawModal');
            modal.style.display = 'block';
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('modalWithdrawDate').value = today;
            document.getElementById('modalWithdrawAmount').value = '';
            document.getElementById('modalWithdrawNote').value = '';
        }
        
        function closeWithdrawModal() {
            document.getElementById('withdrawModal').style.display = 'none';
        }
        
        function saveDepositFromModal() {
            const date = document.getElementById('modalDepositDate').value;
            const amount = document.getElementById('modalDepositAmount').value;
            const note = document.getElementById('modalDepositNote').value;
            
            if (!date || !amount) {
                alert('ÂÖ•ÈáëÊó•„Å®ÂÖ•ÈáëÈ°ç„ÅØÂøÖÈ†àÈ†ÖÁõÆ„Åß„Åô');
                return;
            }
            
            const deposit = {
                id: Date.now(),
                date: date,
                amount: parseInt(amount),
                note: note || '',
                createdAt: new Date().toISOString()
            };
            
            depositData.push(deposit);
            saveDepositData();
            updateDepositTable();
            closeDepositModal();
        }
        
        function saveWithdrawFromModal() {
            const date = document.getElementById('modalWithdrawDate').value;
            const amount = document.getElementById('modalWithdrawAmount').value;
            const note = document.getElementById('modalWithdrawNote').value;
            
            if (!date || !amount) {
                alert('Âá∫ÈáëÊó•„Å®Âá∫ÈáëÈ°ç„ÅØÂøÖÈ†àÈ†ÖÁõÆ„Åß„Åô');
                return;
            }
            
            const withdraw = {
                id: Date.now(),
                date: date,
                amount: parseInt(amount),
                note: note || '',
                createdAt: new Date().toISOString()
            };
            
            withdrawData.push(withdraw);
            saveWithdrawData();
            updateWithdrawTable();
            closeWithdrawModal();
        }

        // Deposit management functions
        function addDeposit() {
            const date = document.getElementById('depositDate').value;
            const amount = document.getElementById('depositAmount').value;
            const note = document.getElementById('depositNote').value;
            
            if (!date || !amount) {
                alert('ÂÖ•ÈáëÊó•„Å®ÂÖ•ÈáëÈ°ç„ÅØÂøÖÈ†àÈ†ÖÁõÆ„Åß„Åô');
                return;
            }
            
            const deposit = {
                id: Date.now(),
                date: date,
                amount: parseInt(amount),
                note: note || '',
                createdAt: new Date().toISOString()
            };
            
            depositData.push(deposit);
            saveDepositData();
            updateDepositTable();
            updateSummary();
            updateCalendar(); // „Ç´„É¨„É≥„ÉÄ„Éº„ÇÇÊõ¥Êñ∞
            
            // Clear form
            document.getElementById('depositDate').value = '';
            document.getElementById('depositAmount').value = '';
            document.getElementById('depositNote').value = '';
            
            showMessage('ÂÖ•Èáë„Éá„Éº„Çø„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü', 'success');
        }
        
        function saveDepositData() {
            localStorage.setItem('depositData', JSON.stringify(depositData));
        }
        
        function updateDepositTable() {
            const tbody = document.getElementById('depositTableBody');
            const noDataMsg = document.getElementById('noDepositData');
            
            if (!tbody) return; // Exit if element doesn't exist
            
            // Get selected year and month
            const yearEl = document.getElementById('cashflowYear');
            const monthEl = document.getElementById('cashflowMonth');
            
            if (!yearEl || !monthEl) {
                // If month selector doesn't exist, show all data
                displayAllDeposits();
                return;
            }
            
            const selectedYear = parseInt(yearEl.value);
            const selectedMonth = parseInt(monthEl.value);
            
            // Filter deposits by selected month
            const filteredDeposits = depositData.filter(deposit => {
                const date = new Date(deposit.date);
                return date.getFullYear() === selectedYear && date.getMonth() + 1 === selectedMonth;
            });
            
            if (filteredDeposits.length === 0) {
                tbody.innerHTML = '';
                if (noDataMsg) noDataMsg.style.display = 'block';
                updateDepositTotal(filteredDeposits);
                updateSummary();
                return;
            }
            
            if (noDataMsg) noDataMsg.style.display = 'none';
            
            // Sort by date (newest first)
            const sortedDeposits = [...filteredDeposits].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sortedDeposits.map(deposit => `
                <tr>
                    <td>${formatDate(deposit.date)}</td>
                    <td>¬•${deposit.amount.toLocaleString()}</td>
                    <td>${deposit.note}</td>
                    <td>
                        <button class="btn-edit" onclick="editDeposit(${deposit.id})">Á∑®ÈõÜ</button>
                        <button class="btn-delete" onclick="deleteDeposit(${deposit.id})">ÂâäÈô§</button>
                    </td>
                </tr>
            `).join('');
            
            updateDepositTotal(filteredDeposits);
            updateSummary();
        }
        
        function displayAllDeposits() {
            const tbody = document.getElementById('depositTableBody');
            const noDataMsg = document.getElementById('noDepositData');
            
            if (depositData.length === 0) {
                tbody.innerHTML = '';
                if (noDataMsg) noDataMsg.style.display = 'block';
                updateDepositTotal([]);
                return;
            }
            
            if (noDataMsg) noDataMsg.style.display = 'none';
            
            // Sort by date (newest first)
            const sortedDeposits = [...depositData].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sortedDeposits.map(deposit => `
                <tr>
                    <td>${formatDate(deposit.date)}</td>
                    <td>¬•${deposit.amount.toLocaleString()}</td>
                    <td>${deposit.note}</td>
                    <td>
                        <button class="btn-edit" onclick="editDeposit(${deposit.id})">Á∑®ÈõÜ</button>
                        <button class="btn-delete" onclick="deleteDeposit(${deposit.id})">ÂâäÈô§</button>
                    </td>
                </tr>
            `).join('');
            
            updateDepositTotal(depositData);
        }
        
        function updateDepositTotal(deposits = null) {
            const dataToSum = deposits || depositData;
            const total = dataToSum.reduce((sum, deposit) => sum + deposit.amount, 0);
            const totalEl = document.getElementById('totalDeposit');
            if (totalEl) {
                totalEl.textContent = `¬•${total.toLocaleString()}`;
            }
        }
        
        function updateDepositDisplay() {
            const yearEl = document.getElementById('cashflowYear');
            const monthEl = document.getElementById('cashflowMonth');
            
            if (yearEl && monthEl) {
                const year = yearEl.value;
                const month = monthEl.value;
                
                // Update deposit titles
                const depositTitleEl = document.getElementById('depositMonthTitle');
                if (depositTitleEl) {
                    depositTitleEl.textContent = `${year}Âπ¥${month}Êúà„ÅÆÂÖ•ÈáëÂ±•Ê≠¥`;
                }
                
                const depositLabelEl = document.getElementById('depositMonthLabel');
                if (depositLabelEl) {
                    depositLabelEl.textContent = `${year}Âπ¥${month}Êúà `;
                }
                
                // Update withdraw titles
                const withdrawTitleEl = document.getElementById('withdrawMonthTitle');
                if (withdrawTitleEl) {
                    withdrawTitleEl.textContent = `${year}Âπ¥${month}Êúà„ÅÆÂá∫ÈáëÂ±•Ê≠¥`;
                }
                
                const withdrawLabelEl = document.getElementById('withdrawMonthLabel');
                if (withdrawLabelEl) {
                    withdrawLabelEl.textContent = `${year}Âπ¥${month}Êúà `;
                }
            }
            
            updateDepositTable();
            updateWithdrawTable();
        }
        
        function changeDepositMonth(direction) {
            const yearEl = document.getElementById('cashflowYear');
            const monthEl = document.getElementById('cashflowMonth');
            
            if (!yearEl || !monthEl) return;
            
            let year = parseInt(yearEl.value);
            let month = parseInt(monthEl.value);
            
            month += direction;
            
            if (month > 12) {
                month = 1;
                year++;
            } else if (month < 1) {
                month = 12;
                year--;
            }
            
            yearEl.value = year;
            monthEl.value = month;
            updateDepositDisplay();
        }
        
        function deleteDeposit(id) {
            if (confirm('„Åì„ÅÆÂÖ•Èáë„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                depositData = depositData.filter(d => d.id !== id);
                saveDepositData();
                updateDepositTable();
                updateSummary();
                updateCalendar(); // „Ç´„É¨„É≥„ÉÄ„Éº„ÇÇÊõ¥Êñ∞
                showMessage('ÂÖ•Èáë„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
            }
        }
        
        function editDeposit(id) {
            const deposit = depositData.find(d => d.id === id);
            if (!deposit) return;
            
            const newDate = prompt('ÂÖ•ÈáëÊó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (YYYY-MM-DD):', deposit.date);
            if (!newDate) return;
            
            const newAmount = prompt('ÂÖ•ÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', deposit.amount);
            if (!newAmount) return;
            
            const newNote = prompt('ÂÇôËÄÉ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', deposit.note);
            
            deposit.date = newDate;
            deposit.amount = parseInt(newAmount);
            deposit.note = newNote || '';
            
            saveDepositData();
            updateDepositTable();
            updateSummary();
            updateCalendar(); // „Ç´„É¨„É≥„ÉÄ„Éº„ÇÇÊõ¥Êñ∞
            showMessage('ÂÖ•Èáë„Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        function getDayDepositTotal(dateStr) {
            const dayDeposits = depositData.filter(deposit => deposit.date === dateStr);
            return dayDeposits.reduce((sum, deposit) => sum + deposit.amount, 0);
        }
        
        // Withdraw management functions
        function addWithdraw() {
            const date = document.getElementById('withdrawDate').value;
            const amount = document.getElementById('withdrawAmount').value;
            const note = document.getElementById('withdrawNote').value;
            
            if (!date || !amount) {
                alert('Âá∫ÈáëÊó•„Å®Âá∫ÈáëÈ°ç„ÅØÂøÖÈ†àÈ†ÖÁõÆ„Åß„Åô');
                return;
            }
            
            const withdraw = {
                id: Date.now(),
                date: date,
                amount: parseInt(amount),
                note: note || '',
                createdAt: new Date().toISOString()
            };
            
            withdrawData.push(withdraw);
            saveWithdrawData();
            updateWithdrawTable();
            updateSummary();
            
            // Clear form
            document.getElementById('withdrawDate').value = '';
            document.getElementById('withdrawAmount').value = '';
            document.getElementById('withdrawNote').value = '';
            
            showMessage('Âá∫Èáë„Éá„Éº„Çø„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü', 'success');
        }
        
        function saveWithdrawData() {
            localStorage.setItem('withdrawData', JSON.stringify(withdrawData));
        }
        
        function updateWithdrawTable() {
            const tbody = document.getElementById('withdrawTableBody');
            const noDataMsg = document.getElementById('noWithdrawData');
            
            if (!tbody) return;
            
            const yearEl = document.getElementById('cashflowYear');
            const monthEl = document.getElementById('cashflowMonth');
            
            if (!yearEl || !monthEl) {
                displayAllWithdraws();
                return;
            }
            
            const selectedYear = parseInt(yearEl.value);
            const selectedMonth = parseInt(monthEl.value);
            
            const filteredWithdraws = withdrawData.filter(withdraw => {
                const date = new Date(withdraw.date);
                return date.getFullYear() === selectedYear && date.getMonth() + 1 === selectedMonth;
            });
            
            if (filteredWithdraws.length === 0) {
                tbody.innerHTML = '';
                if (noDataMsg) noDataMsg.style.display = 'block';
                updateWithdrawTotal(filteredWithdraws);
                updateSummary();
                return;
            }
            
            if (noDataMsg) noDataMsg.style.display = 'none';
            
            const sortedWithdraws = [...filteredWithdraws].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sortedWithdraws.map(withdraw => `
                <tr>
                    <td>${formatDate(withdraw.date)}</td>
                    <td class="withdraw-amount">-¬•${withdraw.amount.toLocaleString()}</td>
                    <td>${withdraw.note}</td>
                    <td>
                        <button class="btn-edit" onclick="editWithdraw(${withdraw.id})">Á∑®ÈõÜ</button>
                        <button class="btn-delete" onclick="deleteWithdraw(${withdraw.id})">ÂâäÈô§</button>
                    </td>
                </tr>
            `).join('');
            
            updateWithdrawTotal(filteredWithdraws);
            updateSummary();
        }
        
        function displayAllWithdraws() {
            const tbody = document.getElementById('withdrawTableBody');
            const noDataMsg = document.getElementById('noWithdrawData');
            
            if (withdrawData.length === 0) {
                tbody.innerHTML = '';
                if (noDataMsg) noDataMsg.style.display = 'block';
                updateWithdrawTotal([]);
                return;
            }
            
            if (noDataMsg) noDataMsg.style.display = 'none';
            
            const sortedWithdraws = [...withdrawData].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sortedWithdraws.map(withdraw => `
                <tr>
                    <td>${formatDate(withdraw.date)}</td>
                    <td class="withdraw-amount">-¬•${withdraw.amount.toLocaleString()}</td>
                    <td>${withdraw.note}</td>
                    <td>
                        <button class="btn-edit" onclick="editWithdraw(${withdraw.id})">Á∑®ÈõÜ</button>
                        <button class="btn-delete" onclick="deleteWithdraw(${withdraw.id})">ÂâäÈô§</button>
                    </td>
                </tr>
            `).join('');
            
            updateWithdrawTotal(withdrawData);
        }
        
        function updateWithdrawTotal(withdraws = null) {
            const dataToSum = withdraws || withdrawData;
            const total = dataToSum.reduce((sum, withdraw) => sum + withdraw.amount, 0);
            const totalEl = document.getElementById('totalWithdraw');
            if (totalEl) {
                totalEl.textContent = `-¬•${total.toLocaleString()}`;
            }
        }
        
        function deleteWithdraw(id) {
            if (confirm('„Åì„ÅÆÂá∫Èáë„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                withdrawData = withdrawData.filter(w => w.id !== id);
                saveWithdrawData();
                updateWithdrawTable();
                showMessage('Âá∫Èáë„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
            }
        }
        
        function editWithdraw(id) {
            const withdraw = withdrawData.find(w => w.id === id);
            if (!withdraw) return;
            
            const newDate = prompt('Âá∫ÈáëÊó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (YYYY-MM-DD):', withdraw.date);
            if (!newDate) return;
            
            const newAmount = prompt('Âá∫ÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', withdraw.amount);
            if (!newAmount) return;
            
            const newNote = prompt('ÂÇôËÄÉ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', withdraw.note);
            
            withdraw.date = newDate;
            withdraw.amount = parseInt(newAmount);
            withdraw.note = newNote || '';
            
            saveWithdrawData();
            updateWithdrawTable();
            showMessage('Âá∫Èáë„Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
        }
        
        function updateSummary() {
            const yearEl = document.getElementById('cashflowYear');
            const monthEl = document.getElementById('cashflowMonth');
            
            let depositTotal = 0;
            let withdrawTotal = 0;
            
            if (yearEl && monthEl) {
                const selectedYear = parseInt(yearEl.value);
                const selectedMonth = parseInt(monthEl.value);
                
                const filteredDeposits = depositData.filter(deposit => {
                    const date = new Date(deposit.date);
                    return date.getFullYear() === selectedYear && date.getMonth() + 1 === selectedMonth;
                });
                
                const filteredWithdraws = withdrawData.filter(withdraw => {
                    const date = new Date(withdraw.date);
                    return date.getFullYear() === selectedYear && date.getMonth() + 1 === selectedMonth;
                });
                
                depositTotal = filteredDeposits.reduce((sum, d) => sum + d.amount, 0);
                withdrawTotal = filteredWithdraws.reduce((sum, w) => sum + w.amount, 0);
            } else {
                depositTotal = depositData.reduce((sum, d) => sum + d.amount, 0);
                withdrawTotal = withdrawData.reduce((sum, w) => sum + w.amount, 0);
            }
            
            const balance = depositTotal - withdrawTotal;
            
            const summaryDepositEl = document.getElementById('summaryDeposit');
            const summaryWithdrawEl = document.getElementById('summaryWithdraw');
            const summaryBalanceEl = document.getElementById('summaryBalance');
            
            if (summaryDepositEl) summaryDepositEl.textContent = `¬•${depositTotal.toLocaleString()}`;
            if (summaryWithdrawEl) summaryWithdrawEl.textContent = `-¬•${withdrawTotal.toLocaleString()}`;
            if (summaryBalanceEl) {
                summaryBalanceEl.textContent = `¬•${balance.toLocaleString()}`;
                summaryBalanceEl.style.color = balance >= 0 ? '#059669' : '#dc2626';
            }
        }
        
        // Initialize with current date
        window.onload = function() {
            const today = new Date();
            document.getElementById('year').value = today.getFullYear();
            document.getElementById('month').value = today.getMonth() + 1;
            
            // Set cashflow year and month
            const cashflowYear = document.getElementById('cashflowYear');
            const cashflowMonth = document.getElementById('cashflowMonth');
            if (cashflowYear) {
                cashflowYear.value = today.getFullYear();
            }
            if (cashflowMonth) {
                cashflowMonth.value = today.getMonth() + 1;
            }
            
            // „Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            document.getElementById('backupBtn').addEventListener('click', saveAllData);
            document.getElementById('downloadBtn').addEventListener('click', downloadData);
            document.getElementById('uploadBtn').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });
            document.getElementById('fileInput').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    uploadData(e.target.files[0]);
                }
            });
            
            // ÂÆöÊúüÁöÑ„Å™Ëá™Âãï‰øùÂ≠ò
            setInterval(function() {
                saveAllData();
            }, 60000); // 1ÂàÜ„Åî„Å®„Å´Ëá™Âãï‰øùÂ≠ò
            
            // SupabaseÂêåÊúü„ÅÆÂàùÊúüÂåñÔºàË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
            if (typeof initSupabase === 'function' && initSupabase()) {
                console.log('Supabase sync initialized');
                syncAllData().then(needsUpdate => {
                    if (needsUpdate) {
                        loadData();
                        updateCalendar();
                        updateStats();
                        updateDepositTable();
                        updateWithdrawTable();
                    }
                });
                setupRealtimeSync();
                
                // ÂÆöÊúüÁöÑ„Å™ÂêåÊúü
                setInterval(() => {
                    syncAllData();
                }, 30000); // 30Áßí„Åî„Å®„Å´ÂêåÊúü
            }
            
            // Set today's date as default for deposit and withdraw forms
            const depositDateInput = document.getElementById('depositDate');
            const withdrawDateInput = document.getElementById('withdrawDate');
            const todayStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            
            if (depositDateInput) {
                depositDateInput.value = todayStr;
            }
            if (withdrawDateInput) {
                withdrawDateInput.value = todayStr;
            }
            
            // Initialize deposit display
            updateDepositDisplay();
        };
    </script>
</body>
</html>